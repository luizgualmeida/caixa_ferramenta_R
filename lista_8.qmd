# Lista 8: CFA e Path Analysis {.unnumbered}

::: {.callout-note appearance="simple" icon=false}
## Objetivo da Lista

Explore **Modelagem de Equa√ß√µes Estruturais (SEM)**: construa modelos de **Path Analysis** (rela√ß√µes entre vari√°veis observadas) e **CFA** (An√°lise Fatorial Confirmat√≥ria - vari√°veis latentes). Aprenda a avaliar ajuste de modelos e interpretar resultados.
:::

---

## üìö O que √© SEM?

::: {.callout-tip}
## Structural Equation Modeling (SEM)

T√©cnica estat√≠stica que combina:
- **An√°lise de regress√£o:** Rela√ß√µes direcionais entre vari√°veis
- **An√°lise fatorial:** Vari√°veis latentes n√£o-observadas

**Dois componentes principais:**

**1. Path Analysis** (An√°lise de Caminhos)
- Rela√ß√µes entre **vari√°veis observadas**
- Testa modelos te√≥ricos de causalidade
- An√°lise de media√ß√£o e modera√ß√£o

**2. CFA** (Confirmatory Factor Analysis)
- Testa estrutura de **vari√°veis latentes**
- Confirma√ß√£o de fatores te√≥ricos
- Valida√ß√£o de question√°rios/escalas
:::

---

## üì¶ Pacotes

```{r}
#| echo: false
#| message: false
#| warning: false

pacotes <- c(
  "foreign", "tidyverse", "lavaan", "semPlot",
  "performance", "easystats", "kableExtra"
)

pacotes_faltantes <- pacotes[!pacotes %in% installed.packages()[, "Package"]]
if (length(pacotes_faltantes) > 0) {
  install.packages(pacotes_faltantes, dependencies = TRUE)
}

invisible(lapply(pacotes, library, character.only = TRUE))
cat("‚úì Pacotes de SEM carregados!\n")
```

---

## üéØ Parte A: Path Analysis

### Contexto dos Dados

::: {.callout-tip}
**Dados:** 94 pessoas

**Vari√°veis:**
- `Idade`: Anos
- `IMC1`: √çndice de Massa Corporal
- `Sociabilidade`: Escore de question√°rio
- `Treinos`: N√∫mero de treinos (VD)

**Pergunta:** Como Idade, IMC e Sociabilidade afetam frequ√™ncia de treinos?
:::

---

### Carregar Dados

```{r}
#| echo: true
#| message: false
#| warning: false

dados_path <- read.spss("DADOS PATH.sav", to.data.frame = TRUE)
glimpse(dados_path)
```

---

### Baseline: Regress√£o Linear

```{r}
#| echo: true

modelo_lm <- lm(Treinos ~ Idade + IMC1 + Sociabilidade, 
                data = dados_path)

summary(modelo_lm)$coefficients %>%
  kable(digits = 3, caption = "Coeficientes de Regress√£o Linear")
```

---

### Modelo de Path Analysis

::: {.callout-note}
## Sintaxe lavaan

Em SEM, especificamos modelos com texto:

**`~`** = "√© regredido por" (Y ~ X)  
**`=~`** = "√© medido por" (Fator =~ itens)  
**`~~`** = "covaria com"
:::

```{r}
#| echo: true

# Especificar modelo (id√™ntico √† regress√£o)
path_modelo <- "Treinos ~ Idade + IMC1 + Sociabilidade"

# Ajustar
fit_path <- sem(path_modelo, data = dados_path)
```

---

### Resultados da Path Analysis

```{r}
#| echo: true

summary(fit_path, standardized = TRUE, fit.measures = TRUE)
```

---

### Tabela de Estimativas

```{r}
#| echo: true

parameterEstimates(fit_path) %>%
  filter(op == "~") %>%
  select(lhs, op, rhs, est, se, z, pvalue, ci.lower, ci.upper) %>%
  kable(
    digits = 3,
    col.names = c("VD", "‚Üê", "VI", "Œ≤", "EP", "z", "p", "IC_low", "IC_up"),
    caption = "Estimativas de Par√¢metros (Path Analysis)"
  )
```

::: {.callout-note}
## üìä Compara√ß√£o: Path vs Regress√£o

**Resultados s√£o id√™nticos!** Path Analysis com apenas vari√°veis observadas = Regress√£o Linear.

**Vantagem do SEM:** Permite modelos mais complexos (m√∫ltiplas VDs, media√ß√£o, vari√°veis latentes)
:::

---

### √çndices de Ajuste

```{r}
#| echo: true

model_performance(
  fit_path,
  metrics = c("Chi2", "Chi2_df", "NFI", "NNFI", "CFI", 
              "RMSEA", "AIC", "BIC")
) %>%
  kable(digits = 3, caption = "√çndices de Ajuste do Modelo")
```

::: {.callout-tip collapse="true"}
## üîç Interpretando √çndices de Ajuste

**œá¬≤ (Chi-quadrado):**
- Testa H‚ÇÄ: modelo perfeito
- p > 0.05 = bom ajuste (mas sens√≠vel a N)

**CFI (Comparative Fit Index):**
- Compara com modelo nulo
- > 0.90 aceit√°vel, > 0.95 bom

**RMSEA (Root Mean Square Error):**
- < 0.05 excelente
- 0.05-0.08 aceit√°vel
- > 0.10 pobre

**AIC/BIC:** Compara√ß√£o entre modelos (menor = melhor)
:::

---

### Diagrama do Modelo

```{r}
#| echo: true
#| fig-width: 8
#| fig-height: 6

semPaths(
  fit_path,
  what = "std",
  whatLabels = "par",
  style = "ram",
  layout = "tree",
  rotation = 2,
  sizeMan = 8,
  edge.label.cex = 1.2,
  label.cex = 1.3,
  color = list(man = "lightblue", lat = "lightgreen")
)
```

---

## üéØ Parte B: An√°lise Fatorial Confirmat√≥ria (CFA)

### Contexto Te√≥rico

::: {.callout-tip}
## Escala de Apego a Amigos (IAA)

**Teoria:** Apego a amigos tem 2 dimens√µes latentes:

**1. Aliena√ß√£o** (sentir-se isolado)
- IAa1, IAa2, IAa3

**2. Confian√ßa** (seguran√ßa nas amizades)
- IAa13, IAa14, IAa15

**Objetivo:** Confirmar essa estrutura com CFA
:::

---

### Carregar Dados

```{r}
#| echo: true
#| message: false
#| warning: false

dados_cfa <- read.spss("fatorial CFA.sav", to.data.frame = TRUE)
glimpse(dados_cfa)
```

---

### Modelo 1: CFA com 2 Fatores

```{r}
#| echo: true

# Especificar modelo
# Vari√°veis latentes (=~ significa 'medido por')
cfa_eq1 <- "
  alienacao =~ IAa1 + IAa2 + IAa3
  confianca =~ IAa13 + IAa14 + IAa15
"

# Ajustar
cfa_modelo1 <- cfa(
  cfa_eq1,
  data = dados_cfa,
  std.lv = TRUE  # Padronizar vari√°veis latentes
)
```

::: {.callout-note}
## `std.lv = TRUE`

Fixa vari√¢ncia das vari√°veis latentes em 1 (padroniza√ß√£o).

**Alternativa:** `std.lv = FALSE` fixa primeira carga fatorial = 1
:::

---

### Resultados do Modelo 1

```{r}
#| echo: true

summary(cfa_modelo1, fit.measures = TRUE, standardized = TRUE)
```

---

### Tabela de Cargas Fatoriais

```{r}
#| echo: true

parameterEstimates(cfa_modelo1) %>%
  filter(op == "=~") %>%
  dplyr::select(lhs, rhs, est, se, z, pvalue, ci.lower, ci.upper) %>%
  kable(
    digits = 3,
    col.names = c("Fator", "Item", "Œª", "EP", "z", "p", "ci lower", "ci upper"),
    caption = "Cargas Fatoriais (Modelo 1)"
  )
```

::: {.callout-tip}
## üìä Interpretando Cargas (Œª)

**Œª_pad (padronizado):**
- > 0.70 = Excelente
- 0.50-0.70 = Aceit√°vel
- < 0.50 = Problem√°tico

Indica quanto cada item "carrega" no fator latente.
:::

---

### √çndices de Ajuste - Modelo 1

```{r}
#| echo: true

model_performance(
  cfa_modelo1,
  metrics = c("Chi2", "Chi2_df", "NFI", "NNFI", "CFI",
              "RMSEA", "p_RMSEA", "AIC", "BIC")
) %>%
  kable(digits = 3, caption = "Ajuste do Modelo 1")
```

::: {.callout-warning}
## ‚ö†Ô∏è Ajuste Moderado

- **CFI/NNFI:** Bons (> 0.90)
- **RMSEA:** Alto (0.10) ‚Üí Modelo pode melhorar

**Pr√≥ximo passo:** Verificar √≠ndices de modifica√ß√£o
:::

---

### √çndices de Modifica√ß√£o

```{r}
#| echo: true

modificationindices(cfa_modelo1, sort = TRUE, minimum.value = 5) %>%
  head(10) %>%
  kable(digits = 3, caption = "Top 10 Modifica√ß√µes Sugeridas")
```

::: {.callout-tip collapse="true"}
## üîç Interpretando MI

**MI (Modification Index):**
- Prediz redu√ß√£o em œá¬≤ se par√¢metro for liberado
- MI > 10 = modifica√ß√£o substancial

**EPC (Expected Parameter Change):**
- Valor esperado do par√¢metro

**Decis√£o:** S√≥ adicionar se **teoricamente justific√°vel**!
:::

---

### Modelo 2: Com Covari√¢ncias de Res√≠duos

```{r}
#| echo: true

cfa_eq2 <- "
  # Fatores
  alienacao =~ IAa1 + IAa2 + IAa3
  confianca =~ IAa13 + IAa14 + IAa15
  
  # Covari√¢ncias de res√≠duos (baseadas em MI)
  IAa1 ~~ IAa3
  IAa13 ~~ IAa14
  IAa13 ~~ IAa15
"

cfa_modelo2 <- cfa(cfa_eq2, data = dados_cfa, std.lv = TRUE)
```

---

### Resultados do Modelo 2

```{r}
#| echo: true

parameterEstimates(cfa_modelo2) %>%
  kable(digits = 3, caption = "Estimativas - Modelo 2")
```

---

### Compara√ß√£o: Modelo 1 vs 2

```{r}
#| echo: true

compare_performance(
  cfa_modelo1, cfa_modelo2,
  metrics = c("NFI", "NNFI", "CFI", "RMSEA", "AIC", "BIC"),
  rank = TRUE, verbose = FALSE
) %>%
  kable(digits = 3, caption = "Compara√ß√£o de Modelos")
```

::: {.callout-note}
## ‚úì Modelo 2 Superior

- **RMSEA** reduzido (0.10 ‚Üí 0.07)
- **AIC/BIC** menores
- **CFI/NNFI** ligeiramente melhores

Covari√¢ncias de res√≠duos melhoraram ajuste!
:::

---

### Diagrama - Modelo 2

```{r}
#| echo: true
#| fig-width: 8
#| fig-height: 7

semPaths(
  cfa_modelo2,
  what = "std",
  whatLabels = "std",
  style = "ram",
  layout = "tree2",
  rotation = 2,
  sizeMan = 7,
  sizeLat = 10,
  edge.label.cex = 1,
  label.cex = 1.2,
  color = list(man = "lightblue", lat = "lightcoral")
)
```

---

## üîç Modelos Alternativos

### Modelo 3: Fator √önico

::: {.callout-tip}
## Hip√≥tese Alternativa

**E se** Aliena√ß√£o e Confian√ßa s√£o na verdade **um √∫nico fator**?

Vamos testar!
:::

```{r}
#| echo: true

cfa_eq3 <- "
  # Um √∫nico fator
  Apego =~ IAa1 + IAa2 + IAa3 + IAa13 + IAa14 + IAa15
"

cfa_modelo3 <- cfa(cfa_eq3, data = dados_cfa, std.lv = TRUE)
```

---

### Modelo 4: Fator √önico + Covari√¢ncias

```{r}
#| echo: true

# Verificar MI do modelo 3
mi3 <- modificationindices(cfa_modelo3, minimum.value = 5)

# Adicionar principais covari√¢ncias
cfa_eq4 <- "
  Apego =~ IAa1 + IAa2 + IAa3 + IAa13 + IAa14 + IAa15
  
  # Covari√¢ncias
  IAa2 ~~ IAa14
  IAa13 ~~ IAa14
"

cfa_modelo4 <- cfa(cfa_eq4, data = dados_cfa, std.lv = TRUE)
```

---

### Compara√ß√£o Final: Todos os Modelos

```{r}
#| echo: true

compare_performance(
  cfa_modelo1, cfa_modelo2, cfa_modelo3, cfa_modelo4,
  metrics = c("Chi2", "NFI", "NNFI", "CFI", "RMSEA", "AIC", "BIC"),
  rank = TRUE, verbose = FALSE
) %>%
  kable(digits = 3, caption = "Compara√ß√£o Completa de Modelos CFA")
```

::: {.callout-note}
## üèÜ Modelo Vencedor

**Modelo 4** (fator √∫nico + covari√¢ncias):
- Melhor RMSEA (0.046)
- Melhores CFI/NNFI (> 0.97)
- Menores AIC/BIC

**Mas...** Teoria sugere 2 fatores! Decis√£o final deve considerar teoria + ajuste.
:::

---

### Diagrama - Modelo 4

```{r}
#| echo: true
#| fig-width: 8
#| fig-height: 7

semPaths(
  cfa_modelo4,
  what = "std",
  whatLabels = "std",
  style = "ram",
  layout = "circle",
  sizeMan = 7,
  sizeLat = 12,
  edge.label.cex = 1,
  label.cex = 1.2,
  color = list(man = "lightyellow", lat = "lightcoral")
)
```

---

## üìä Guia de Interpreta√ß√£o

::: {.callout-tip collapse="true"}
## üó∫Ô∏è Checklist de An√°lise SEM

**1. Especifica√ß√£o do Modelo**
- [ ] Baseado em teoria s√≥lida
- [ ] Identificado (df ‚â• 0)
- [ ] Par√¢metros interpret√°veis

**2. Avalia√ß√£o de Ajuste**
- [ ] œá¬≤: p > 0.05 (ideal, mas sens√≠vel a N)
- [ ] CFI/NNFI: > 0.95 (> 0.90 aceit√°vel)
- [ ] RMSEA: < 0.05 (< 0.08 aceit√°vel)
- [ ] SRMR: < 0.08

**3. Interpreta√ß√£o de Par√¢metros**
- [ ] Cargas fatoriais: > 0.50 (> 0.70 ideal)
- [ ] Todos significativos (p < 0.05)
- [ ] Dire√ß√£o teoricamente esperada
- [ ] Aus√™ncia de casos Heywood (vari√¢ncias negativas)

**4. Modifica√ß√µes**
- [ ] Baseadas em MI > 10
- [ ] Teoricamente justific√°veis
- [ ] N√£o data-driven exclusivamente
- [ ] Valida√ß√£o cruzada se poss√≠vel

**5. Compara√ß√£o de Modelos**
- [ ] ŒîCFI > 0.01 = diferen√ßa substancial
- [ ] ŒîRMSEA > 0.015 = diferen√ßa substancial
- [ ] Considerar parcim√¥nia (menos par√¢metros)
:::

---

## üìö Material Complementar

{{< video https://www.youtube.com/watch?v=f_fXWuCGssQ title='SEM - CFA e Path Analysis - Aula Pr√°tica #8' >}}

---

### Recursos Adicionais

::: {.callout-note collapse="true"}
## üìñ Aprofundamento em SEM

**Pacote lavaan:**
- [Tutorial Oficial](https://lavaan.ugent.be/tutorial/)
- [Rosseel (2012). JSS Paper](https://www.jstatsoft.org/article/view/v048i02)

**Livros:**
- Kline (2015). *Principles and Practice of SEM*
- Brown (2015). *Confirmatory Factor Analysis*

**T√≥picos Avan√ßados:**
- Modelos multigrupo (invari√¢ncia)
- Vari√°veis categ√≥ricas (WLSMV)
- Modelos de crescimento (LGM)
- SEM bayesiano
:::

---

## üîß Informa√ß√µes de Sess√£o

```{r}
report(sessionInfo())
```

---

::: {.callout-note appearance="simple"}
## üéì Resumo da Lista 8

Nesta lista voc√™:

‚úÖ Compreendeu diferen√ßa entre **Path Analysis** e **CFA**  
‚úÖ Especificou modelos em **sintaxe lavaan**  
‚úÖ Ajustou e interpretou **cargas fatoriais**  
‚úÖ Avaliou **√≠ndices de ajuste** (CFI, RMSEA, etc.)  
‚úÖ Usou **√≠ndices de modifica√ß√£o** para melhorar modelos  
‚úÖ Comparou **modelos aninhados** e n√£o-aninhados  
‚úÖ Criou **diagramas** de modelos SEM  

**Conceitos-chave:**
- SEM = Regress√£o + An√°lise Fatorial
- Path Analysis: apenas vari√°veis observadas
- CFA: testa estrutura de vari√°veis latentes
- =~ "√© medido por", ~ "√© regredido por"
- √çndices de ajuste: CFI, RMSEA, œá¬≤
- Modifica√ß√µes devem ser teoricamente justificadas

**Aplica√ß√µes:**
- Valida√ß√£o de escalas/question√°rios
- Testes de modelos te√≥ricos
- An√°lise de media√ß√£o/modera√ß√£o
- Modelos de equa√ß√µes simult√¢neas

**Pr√≥ximos passos:**
- SEM completo (Path + CFA combinados)
- Media√ß√£o e modera√ß√£o
- Modelos multigrupo
- An√°lise de invari√¢ncia
:::