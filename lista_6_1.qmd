# Lista 6.1: Cox com CovariÃ¡veis Tempo-Dependentes {.unnumbered}

::: {.callout-note appearance="simple" icon=false}
## Objetivo da Lista

Aprenda a lidar com **violaÃ§Ãµes de proporcionalidade** em modelos Cox usando **covariÃ¡veis tempo-dependentes**. Trabalharemos com dados de 628 pacientes de nefrologia acompanhados por ~1000 dias.
:::

---

## ğŸ“– Contexto do Estudo

::: {.callout-tip}
## Estudo de Transplante Renal

**Amostra:** 628 pacientes de serviÃ§o de nefrologia

**Seguimento:** ~1000 dias

**VariÃ¡veis:**
- `time`: Tempo de seguimento
- `morte`: Ã“bito (evento de interesse)
- `treat`: Realizou transplante? (0 = nÃ£o, 1 = sim)
- `Tempo_dialise`: Tempo em diÃ¡lise (meses)
- `age`: Idade
- `race`: RaÃ§a (branco vs negro/pardo)

**Pergunta:** Transplante aumenta sobrevida? Mas... **e se o efeito muda ao longo do tempo?**
:::

---

## ğŸ“¦ Pacotes

```{r}
#| echo: true
#| message: false
#| warning: false

pacotes <- c(
  "tidyverse", "foreign", "ggplot2", "kableExtra",
  "survival", "ggsurvfit", "survminer", "broom",
  "gtsummary", "coin", "report"
)

pacotes_faltantes <- pacotes[!pacotes %in% installed.packages()[, "Package"]]
if (length(pacotes_faltantes) > 0) {
  install.packages(pacotes_faltantes, dependencies = TRUE)
}

invisible(lapply(pacotes, library, character.only = TRUE))
cat("âœ“ Pacotes carregados!\n")
```

---

## ğŸ“¥ PreparaÃ§Ã£o dos Dados

```{r}
#| echo: true
#| message: false
#| warning: false

# Carregar e preparar
original <- read.spss("Cox tempo dependente 2_1.sav", 
                      to.data.frame = TRUE)

# Converter tipos
db <- original %>%
  mutate(
    morte = as.integer(morte == "Sim"),
    treat = as.factor(treat)
  )

glimpse(db)
```

---

### Verificar Dados Faltantes

```{r}
#| echo: true

db %>%
  summarise(across(everything(), ~sum(is.na(.)))) %>%
  pivot_longer(everything(), names_to = "VariÃ¡vel", values_to = "NAs") %>%
  kable(caption = "Dados Faltantes por VariÃ¡vel")
```

---

## ğŸ”„ RevisÃ£o: AnÃ¡lise Cox PadrÃ£o

### Objeto de Sobrevida

```{r}
#| echo: true

surv_obj <- Surv(time = db$time, event = db$morte)
```

---

### Curva de Kaplan-Meier

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 6

fit_km <- survfit(surv_obj ~ treat, data = db)

ggsurvfit(fit_km, linewidth = 1.2) +
  labs(
    title = "Sobrevida: Transplante vs NÃ£o-Transplante",
    x = "Tempo (dias)",
    y = "Probabilidade de Sobrevida"
  ) +
  add_confidence_interval(alpha = 0.2) +
  add_risktable() +
  scale_ggsurvfit() +
  scale_x_continuous(breaks = seq(0, 1000, by = 100)) +
  theme_minimal()
```

---

### Testes de ComparaÃ§Ã£o

```{r}
#| echo: true

# Log-rank
logrank_test(surv_obj ~ treat, data = db, type = "logrank")
```

---

### Modelo Cox PadrÃ£o

```{r}
#| echo: true

cox_padrao <- coxph(surv_obj ~ treat, data = db)

tbl_regression(cox_padrao, 
               exponentiate = TRUE,
               label = list(treat ~ "Transplante"))
```

---

## âš ï¸ Problema: ViolaÃ§Ã£o de Proporcionalidade

### Teste de Schoenfeld

```{r}
#| echo: true

test_prop <- cox.zph(cox_padrao)
print(test_prop)
```

::: {.callout-warning}
## ğŸš¨ ViolaÃ§Ã£o Detectada!

**p < 0.05** â†’ Riscos **NÃƒO** sÃ£o proporcionais!

O efeito do transplante **muda ao longo do tempo**. Modelo Cox padrÃ£o nÃ£o Ã© apropriado!
:::

---

### VisualizaÃ§Ã£o dos ResÃ­duos

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 6

ggcoxzph(test_prop, point.size = 0.5)
```

::: {.callout-note collapse="true"}
## ğŸ” Interpretando o GrÃ¡fico

**O que procurar:**
- **Linha horizontal:** Proporcionalidade OK
- **TendÃªncia clara:** ViolaÃ§Ã£o! Efeito muda com tempo

**Neste caso:** Linha de suavizaÃ§Ã£o tem **inclinaÃ§Ã£o** â†’ Î²(t) nÃ£o Ã© constante
:::

---

## ğŸ”§ SoluÃ§Ã£o: CovariÃ¡veis Tempo-Dependentes

::: {.callout-tip}
## O que sÃ£o CovariÃ¡veis Tempo-Dependentes?

Permitem que o **efeito de uma variÃ¡vel mude ao longo do tempo**.

**Modelo padrÃ£o:** Î² Ã© constante  
**Modelo tempo-dependente:** Î²(t) varia com tempo

**TrÃªs abordagens comuns:**

1. **Linear:** `x Ã— t` â†’ Efeito muda linearmente
2. **LogarÃ­tmica:** `x Ã— log(t)` â†’ MudanÃ§a desacelera
3. **Threshold:** `x Ã— (t > corte)` â†’ Dois perÃ­odos distintos
:::

---

### Identificando a CovariÃ¡vel

::: {.callout-important}
## FundamentaÃ§Ã£o TeÃ³rica!

Pela **literatura mÃ©dica**: **Tempo em diÃ¡lise** afeta diferentemente pacientes em diferentes estÃ¡gios.

**HipÃ³tese:** Efeito do tempo em diÃ¡lise **nÃ£o Ã© constante** ao longo do acompanhamento.
:::

```{r}
#| echo: true

# Verificar variÃ¡vel
glimpse(db$Tempo_dialise)
```

---

## ğŸ“Š Modelagem Tempo-Dependente

### Modelo 1: Sem Tempo-DependÃªncia (Baseline)

```{r}
#| echo: true

modelo_base <- coxph(
  surv_obj ~ treat + Tempo_dialise,
  data = db
)

summary(modelo_base)
```

---

### Modelo 2: MudanÃ§a Linear

```{r}
#| echo: true

modelo_linear <- coxph(
  surv_obj ~ treat + Tempo_dialise + tt(Tempo_dialise),
  data = db,
  tt = function(x, t, ...) x * t
)

summary(modelo_linear)
```

::: {.callout-note}
## ğŸ“Š InterpretaÃ§Ã£o

**`Tempo_dialise`:** Efeito no tempo **t = 0**  
**`tt(Tempo_dialise)`:** **MudanÃ§a** do efeito por unidade de tempo

**Efeito total em tempo t:**  
Î²(t) = Î²â‚€ + Î²â‚ Ã— t
:::

---

### Modelo 3: MudanÃ§a LogarÃ­tmica

```{r}
#| echo: true

modelo_log <- coxph(
  surv_obj ~ treat + Tempo_dialise + tt(Tempo_dialise),
  data = db,
  tt = function(x, t, ...) x * log(t)
)

summary(modelo_log)
```

---

### Modelo 4: Threshold (Corte em 650 dias)

```{r}
#| echo: true

modelo_threshold <- coxph(
  surv_obj ~ treat + Tempo_dialise + tt(Tempo_dialise),
  data = db,
  tt = function(x, t, ...) x * (t > 650)
)

summary(modelo_threshold)
```

---

## ğŸ¯ ComparaÃ§Ã£o de Modelos

```{r}
#| echo: true

comparacao <- data.frame(
  Modelo = c("Base", "Linear", "Log", "Threshold (650)"),
  AIC = c(
    AIC(modelo_base),
    AIC(modelo_linear),
    AIC(modelo_log),
    AIC(modelo_threshold)
  ),
  BIC = c(
    BIC(modelo_base),
    BIC(modelo_linear),
    BIC(modelo_log),
    BIC(modelo_threshold)
  )
) %>%
  mutate(
    AIC = round(AIC, 2),
    BIC = round(BIC, 2),
    Melhor_AIC = ifelse(AIC == min(AIC), "â˜…", ""),
    Melhor_BIC = ifelse(BIC == min(BIC), "â˜…", "")
  )

kable(comparacao, caption = "ComparaÃ§Ã£o de Modelos (â˜… = melhor)")
```

::: {.callout-note}
## ğŸ“Š Resultado

Modelo **logarÃ­tmico** apresenta melhor ajuste (menor AIC/BIC)!
:::

---

### Visualizando Î²(t) para Tempo_dialise

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 6

# ResÃ­duos de Schoenfeld para Tempo_dialise
cox_base_dialise <- coxph(surv_obj ~ treat + Tempo_dialise, data = db)

ggcoxzph(
  cox.zph(cox_base_dialise),
  var = "Tempo_dialise",
  point.size = 0.5
)
```

::: {.callout-note}
Observe tendÃªncia **aproximadamente linear** â†’ Justifica modelo linear/log
:::

---

## ğŸ” Modelo Completo com CovariÃ¡veis

```{r}
#| echo: true

modelo_completo <- coxph(
  surv_obj ~ age + race + treat + Tempo_dialise + tt(Tempo_dialise),
  data = db,
  tt = function(x, t, ...) x * t
)

summary(modelo_completo)
```

---

### Tabela Formatada

```{r}
#| echo: true

tbl_regression(
  modelo_completo,
  exponentiate = TRUE,
  label = list(
    age ~ "Idade",
    race ~ "RaÃ§a",
    treat ~ "Transplante",
    Tempo_dialise ~ "Tempo DiÃ¡lise (t=0)",
    `tt(Tempo_dialise)` ~ "Î” Tempo DiÃ¡lise (por dia)"
  )
) %>%
  bold_p()
```

---

## ğŸ“Š AnÃ¡lise Estratificada por RaÃ§a

::: {.callout-note}
**RaÃ§a** mostrou-se significativa! Vamos explorar separadamente.
:::

### Dados: Brancos

```{r}
#| echo: true

db_branco <- db %>% filter(race == "branco")
surv_branco <- Surv(time = db_branco$time, event = db_branco$morte)

fit_branco <- survfit(surv_branco ~ treat, data = db_branco)
```

---

#### Curva K-M: Brancos

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 6

ggsurvfit(fit_branco, linewidth = 1.2) +
  labs(
    title = "Sobrevida: Pacientes Brancos",
    x = "Tempo (dias)",
    y = "Probabilidade de Sobrevida"
  ) +
  add_confidence_interval(alpha = 0.2) +
  scale_ggsurvfit() +
  theme_minimal()
```

---

#### Modelo Cox: Brancos

```{r}
#| echo: true

modelo_branco <- coxph(
  surv_branco ~ age + treat + Tempo_dialise + tt(Tempo_dialise),
  data = db_branco,
  tt = function(x, t, ...) x * t
)

tbl_regression(modelo_branco, exponentiate = TRUE)
```

---

### Dados: Negros/Pardos

```{r}
#| echo: true

db_pardo_negro <- db %>% filter(race == "negro/pardo")
surv_pardo_negro <- Surv(time = db_pardo_negro$time, 
                         event = db_pardo_negro$morte)

fit_pardo_negro <- survfit(surv_pardo_negro ~ treat, 
                           data = db_pardo_negro)
```

---

#### Curva K-M: Negros/Pardos

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 6

ggsurvfit(fit_pardo_negro, linewidth = 1.2) +
  labs(
    title = "Sobrevida: Pacientes Negros/Pardos",
    x = "Tempo (dias)",
    y = "Probabilidade de Sobrevida"
  ) +
  add_confidence_interval(alpha = 0.2) +
  scale_ggsurvfit() +
  theme_minimal()
```

---

#### Modelo Cox: Negros/Pardos

```{r}
#| echo: true

modelo_pardo_negro <- coxph(
  surv_pardo_negro ~ age + treat + Tempo_dialise + tt(Tempo_dialise),
  data = db_pardo_negro,
  tt = function(x, t, ...) x * t
)

tbl_regression(modelo_pardo_negro, exponentiate = TRUE)
```

---

## ğŸ“Š ComparaÃ§Ã£o Entre Grupos Raciais

```{r}
#| echo: true

# Extrair HRs de transplante
hr_branco <- exp(coef(modelo_branco)["treat1"])
hr_pardo_negro <- exp(coef(modelo_pardo_negro)["treat1"])

comparacao_raca <- data.frame(
  Grupo = c("Brancos", "Negros/Pardos"),
  HR_Transplante = c(hr_branco, hr_pardo_negro),
  IC_Lower = c(
    exp(confint(modelo_branco)["treat1", 1]),
    exp(confint(modelo_pardo_negro)["treat1", 1])
  ),
  IC_Upper = c(
    exp(confint(modelo_branco)["treat1", 2]),
    exp(confint(modelo_pardo_negro)["treat1", 2])
  )
) %>%
  mutate(across(where(is.numeric), ~round(., 3)))

kable(comparacao_raca, 
      caption = "HR do Transplante por Grupo Racial")
```

---

## ğŸ“ Conceitos-Chave

::: {.callout-tip collapse="true"}
## ğŸ“š Resumo Conceitual

**Proporcionalidade de Riscos:**
- Pressuposto: HR constante ao longo do tempo
- Teste: ResÃ­duos de Schoenfeld
- p < 0.05 â†’ ViolaÃ§Ã£o!

**CovariÃ¡veis Tempo-Dependentes:**
- Permitem Î²(t) variar com tempo
- TrÃªs formas: linear, log, threshold
- Escolha baseada em AIC/BIC + teoria

**InterpretaÃ§Ã£o:**
- **Î²â‚€:** Efeito no tempo inicial
- **Î²â‚:** Taxa de mudanÃ§a do efeito
- **Î²(t) = Î²â‚€ + Î²â‚ Ã— f(t)** onde f(t) = t, log(t), ou (t>corte)

**Quando usar:**
- Teste de proporcionalidade significativo
- Teoria sugere efeito muda com tempo
- GrÃ¡fico de resÃ­duos mostra tendÃªncia
:::

---

## ğŸ“š Material Complementar

{{< video https://www.youtube.com/watch?v=6FvdrOpz0XU title='Cox Tempo Dependente - Aula PrÃ¡tica #6.1' >}}

---

### Recursos Adicionais

::: {.callout-note collapse="true"}
## ğŸ“– Leituras AvanÃ§adas

**Tutoriais:**
- [UCLA: Survival Analysis in R](https://stats.oarc.ucla.edu/wp-content/uploads/2022/05/survival_r.html)
- [YouTube: Time-Dependent Cox](https://www.youtube.com/watch?v=Y_83HXuHMdc)

**Conceitos:**
- FunÃ§Ã£o `tt()`: transforma covariÃ¡vel ao longo do tempo
- `tmerge()`: alternativa para criar dados tempo-dependentes
- StratificaÃ§Ã£o vs tempo-dependÃªncia
:::

---

## ğŸ”§ InformaÃ§Ãµes de SessÃ£o

```{r}
report(sessionInfo())
```

---

::: {.callout-note appearance="simple"}
## ğŸ“ Resumo da Lista 6.1

Nesta lista vocÃª:

âœ… Identificou **violaÃ§Ã£o de proporcionalidade** com teste de Schoenfeld  
âœ… Compreendeu **covariÃ¡veis tempo-dependentes** (linear, log, threshold)  
âœ… Ajustou modelos Cox com **efeitos variando no tempo**  
âœ… Comparou modelos via **AIC/BIC**  
âœ… Realizou **anÃ¡lise estratificada** por raÃ§a  
âœ… Interpretou **Î²(t)** e sua mudanÃ§a temporal  

**Conceitos-chave:**
- Proporcionalidade: HR constante ao longo do tempo
- ViolaÃ§Ã£o: Î²(t) nÃ£o Ã© constante
- tt(x): transforma x para variar com tempo
- Î²(t) = Î²â‚€ + Î²â‚ Ã— f(t)
- Escolha de f(t) baseada em teoria + dados

**Quando usar Cox tempo-dependente:**
- Teste de Schoenfeld significativo (p < 0.05)
- GrÃ¡fico de resÃ­duos mostra tendÃªncia clara
- Teoria sugere efeito muda com tempo
- Eventos/exposiÃ§Ãµes ocorrem durante seguimento

**PrÃ³ximos passos:**
- Explorar modelos com mÃºltiplas covariÃ¡veis tempo-dependentes
- ValidaÃ§Ã£o cruzada temporal
- Modelos de fragilidade para heterogeneidade nÃ£o-observada
:::