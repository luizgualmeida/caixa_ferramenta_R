# Lista 4: Modelos HierÃ¡rquicos e ICC {.unnumbered}

::: {.callout-note appearance="simple" icon=false}
## Objetivo da Lista

Aprenda a trabalhar com **modelos hierÃ¡rquicos de 3 nÃ­veis** (alunos â†’ classes â†’ escolas) e utilize o **ICC** para decidir quais variÃ¡veis devem ser efeitos aleatÃ³rios.
:::

---

## ğŸ“– Contexto: Estudo TVSFP

::: {.callout-tip collapse="true"}
## Television, School and Family Smoking Prevention Project

**Objetivo:** Avaliar eficÃ¡cia de programas anti-tabagismo

**IntervenÃ§Ãµes:**
- **CC:** CurrÃ­culo presencial
- **TV:** Programa televisivo

**4 Grupos:** Curriculum&TV, Curriculum, TV, Neither (controle)

**Amostra:** 1.600 alunos, 135 classes, 28 escolas (Los Angeles)

**VD:** THKS (Tobacco and Health Knowledge Scale) prÃ© e pÃ³s
:::

---

## ğŸ“¦ Pacotes

```{r}
#| echo: false
#| message: false
#| warning: false

pacotes <- c("emmeans", "lme4", "nlme", "flexplot", "foreign",
             "dplyr", "ggplot2", "forcats", "performance",
             "easystats", "misty", "tidyr", "kableExtra")

pacotes_faltantes <- pacotes[!pacotes %in% installed.packages()[, "Package"]]
if (length(pacotes_faltantes) > 0) install.packages(pacotes_faltantes, dependencies = TRUE)
invisible(lapply(pacotes, library, character.only = TRUE))
```

---

## ğŸ“¥ Dados

```{r}
#| echo: true
#| message: false
#| warning: false

dataset <- read.spss("THKS2.sav", to.data.frame = TRUE)

# Corrigir tipos
dataset$SchoolID <- as.factor(dataset$SchoolID)
dataset$ClassID <- as.factor(dataset$ClassID)
dataset$PreTHKS <- as.integer(dataset$PreTHKS)
dataset$PosTHKS <- as.integer(dataset$PosTHKS)
dataset$Tamanho_Classe <- ave(dataset$PreTHKS, dataset$SchoolID, dataset$ClassID, FUN = length)
```

---

## ğŸ¯ Parte A: AnÃ¡lise Visual dos NÃ­veis

### Por Escola

```{r}
#| echo: true
#| message: false
#| warning: false
#| fig-width: 10
#| fig-height: 6

media_escola <- aggregate(cbind(PreTHKS, PosTHKS) ~ SchoolID, data = dataset, FUN = mean)
media_escola_long <- pivot_longer(media_escola, cols = c("PreTHKS", "PosTHKS"), names_to = "tempo", values_to = "media")

ggplot(media_escola_long, aes(x = fct_rev(tempo), y = media, color = SchoolID, group = SchoolID)) +
  geom_point(size = 3) + geom_line() +
  labs(title = "TrajetÃ³ria por Escola", x = "", y = "MÃ©dia THKS") +
  theme_minimal() + theme(legend.position = "right")
```

**PadrÃ£o:** Aumento consistente â†’ Escola = efeito fixo?

---

### Por Classe

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 7

media_classe <- aggregate(cbind(PreTHKS, PosTHKS) ~ ClassID, data = dataset, FUN = mean)
media_classe_long <- pivot_longer(media_classe, cols = c("PreTHKS", "PosTHKS"), names_to = "tempo", values_to = "media")

ggplot(media_classe_long, aes(x = fct_rev(tempo), y = media, color = ClassID, group = ClassID)) +
  geom_point(size = 2) + geom_line(alpha = 0.4) +
  labs(title = "TrajetÃ³ria por Classe (135 classes)", x = "", y = "MÃ©dia THKS") +
  theme_minimal() + theme(legend.position = "none")
```

**PadrÃ£o:** HeterogÃªneo â†’ Classe = efeito aleatÃ³rio!

---

## ğŸ¯ Parte D: ICC

### Modelo 1: Com Preditores

```{r}
#| echo: true

modelo_1 <- lmer(PosTHKS ~ 1 + Group * PreTHKS + (1|SchoolID:ClassID) + (1|SchoolID), data = dataset, REML = TRUE)
var_modelo_1 <- as.data.frame(VarCorr(modelo_1))

var_classe_1 <- var_modelo_1$vcov[1]
var_escola_1 <- var_modelo_1$vcov[2]
var_erro_1 <- var_modelo_1$vcov[3]

icc_escola_1 <- var_escola_1 / (var_escola_1 + var_erro_1)
icc_classe_1 <- var_classe_1 / (var_classe_1 + var_erro_1)

cat("ICC Escola:", round(icc_escola_1, 4), "=", round(icc_escola_1 * 100, 2), "%\n")
cat("ICC Classe:", round(icc_classe_1, 4), "=", round(icc_classe_1 * 100, 2), "%\n")
```

---

### Modelo 2: Apenas AleatÃ³rios

```{r}
#| echo: true

modelo_2 <- lmer(PosTHKS ~ 1 + (1|SchoolID:ClassID) + (1|SchoolID), data = dataset, REML = TRUE)
var_modelo_2 <- as.data.frame(VarCorr(modelo_2))

icc_escola_2 <- var_modelo_2$vcov[2] / (var_modelo_2$vcov[2] + var_modelo_2$vcov[3])
icc_classe_2 <- var_modelo_2$vcov[1] / (var_modelo_2$vcov[1] + var_modelo_2$vcov[3])

cat("ICC Escola:", round(icc_escola_2, 4), "=", round(icc_escola_2 * 100, 2), "%\n")
cat("ICC Classe:", round(icc_classe_2, 4), "=", round(icc_classe_2 * 100, 2), "%\n")
```

::: {.callout-note}
Escola passa de <5% para >5% sem preditores!
:::


---

## ğŸ¯ Parte E: Modelo Final

```{r}
#| echo: true

dataset$Group <- relevel(dataset$Group, ref = "Neither")

modelo_final <- lme(
  fixed = PosTHKS ~ 1 + PreTHKS + Group,
  random = ~1|SchoolID/ClassID,
  data = dataset,
  method = "REML"
)
```

### DiagnÃ³stico

```{r}
#| fig-height: 10
#| fig-width: 12

check_model(modelo_final)
```

### ComparaÃ§Ãµes

```{r}
#| echo: true

comparacoes <- emmeans(modelo_final, pairwise ~ Group, adjust = "bonferroni")
comparacoes$contrasts
```

### VisualizaÃ§Ã£o

```{r}
#| fig-width: 10
#| fig-height: 6

means_plot <- as.data.frame(comparacoes$emmeans)

ggplot(means_plot, aes(x = reorder(Group, -emmean), y = emmean, fill = Group)) +
  geom_col(alpha = 0.8) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.2) +
  labs(title = "THKS PÃ³s-IntervenÃ§Ã£o por Grupo", y = "THKS Estimado") +
  theme_minimal() + theme(legend.position = "none")
```

---

## ğŸ”§ Extras

### FunÃ§Ã£o ICC Personalizada

```{r}
#| echo: true

icc_lme_3nv <- function(modelo) {
  var_escola <- as.numeric(VarCorr(modelo)[2, "Variance"])
  var_classe <- as.numeric(VarCorr(modelo)[4, "Variance"])
  var_res <- as.numeric(VarCorr(modelo)[5, "Variance"])
  
  list(
    ICC_Escola = var_escola / (var_escola + var_res),
    ICC_Classe = var_classe / (var_classe + var_res)
  )
}

icc_lme_3nv(modelo_final)
```

### ComparaÃ§Ã£o Modelos

```{r}
#| echo: true

compare_performance(modelo_1, modelo_2, metrics = c("AIC", "BIC"), rank = TRUE)
```

---

## ğŸ“š Material Complementar

{{< video https://www.youtube.com/watch?v=_1lUvEu8M9c title='HGMM - Aula PrÃ¡tica #4 (SPSS)' >}}

---

## ğŸ”§ SessÃ£o

```{r}
report(sessionInfo())
```