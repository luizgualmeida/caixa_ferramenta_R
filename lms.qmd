# Modelos Lineares {.unnumbered}

::: {.callout-note appearance="simple" icon=false}
## Vis√£o Geral do Cap√≠tulo

Este cap√≠tulo apresenta quatro abordagens fundamentais para an√°lise de dados longitudinais e correlacionados: **GLM de Medidas Repetidas**, **GEE**, **GMM** e **GzLM**. Cada modelo possui caracter√≠sticas espec√≠ficas que os tornam adequados para diferentes desenhos de pesquisa.
:::

---

## üìä Os Quatro Modelos

::: {.panel-tabset}

### GLM - Medidas Repetidas

**Modelo Linear Geral de Medidas Repetidas**

Extens√£o do modelo linear tradicional projetado especificamente para dados com observa√ß√µes correlacionadas ao longo do tempo.

**Quando usar:**
- Estudos longitudinais com medi√ß√µes repetidas
- Mesmos participantes avaliados em m√∫ltiplos momentos
- Necessidade de modelar estrutura de covari√¢ncia entre medi√ß√µes

**Exemplo pr√°tico:**
Acompanhamento de pacientes em tratamento m√©dico, medindo regularmente biomarcadores para observar mudan√ßas ao longo do tempo.

### GEE - Equa√ß√µes Estimadas

**Generalized Estimated Equations**

Abordagem robusta para dados longitudinais que fornece estimativas eficientes mesmo quando a especifica√ß√£o da covari√¢ncia n√£o √© perfeita.

**Quando usar:**
- Estudos observacionais longitudinais
- Ensaios cl√≠nicos com medi√ß√µes correlacionadas
- Estudos epidemiol√≥gicos multic√™ntricos

**Exemplo pr√°tico:**
Investiga√ß√£o da efic√°cia de programa de interven√ß√£o em sa√∫de onde observa√ß√µes est√£o correlacionadas dentro de grupos de participantes.

### GMM - Modelos Mistos

**Modelos Mistos e Hier√°rquicos**

Combinam componentes fixos e aleat√≥rios, ideais para dados com estrutura hier√°rquica ou multic√™ntrica.

**Quando usar:**
- Dados com estrutura hier√°rquica
- Estudos multic√™ntricos
- Observa√ß√µes agrupadas em diferentes n√≠veis

**Exemplo pr√°tico:**
Avalia√ß√£o de desempenho acad√™mico onde alunos (n√≠vel 1) est√£o agrupados em salas (n√≠vel 2) e escolas (n√≠vel 3), considerando efeitos individuais e contextuais.

### GzLM - Lineares Generalizados

**Generalized Linear Models**

Extens√£o dos modelos lineares para vari√°veis resposta n√£o-normais, permitindo diferentes distribui√ß√µes e fun√ß√µes de liga√ß√£o.

**Quando usar:**
- Dados de contagem (Poisson)
- Dados bin√°rios (Log√≠stica)
- Dados com distribui√ß√£o n√£o-normal

**Exemplo pr√°tico:**
An√°lise de n√∫mero de eventos adversos (contagem) em ensaio cl√≠nico ou modelagem de probabilidade de sucesso em tratamento (bin√°rio).

:::

---

## üéØ Por que usar Modelos de Medidas Repetidas?

::: {.callout-tip}
## Vantagens sobre ANOVA Tradicional

Os modelos lineares modernos oferecem melhorias substanciais sobre a ANOVA cl√°ssica:

1. **Modelagem Flex√≠vel**
   - M√∫ltiplos fatores independentes em um √∫nico modelo
   - An√°lise de intera√ß√µes complexas
   - Estruturas de covari√¢ncia personalizadas

2. **Robustez a Viola√ß√µes**
   - Dados desequilibrados
   - Heterogeneidade de vari√¢ncias
   - Desvios da normalidade

3. **Controle Estat√≠stico**
   - Inclus√£o de covari√°veis
   - Ajuste para vari√°veis confundidoras
   - Maior precis√£o nas estimativas

4. **Poder Estat√≠stico**
   - Aproveitamento da correla√ß√£o entre medidas
   - Detec√ß√£o de efeitos com amostras menores
   - An√°lise eficiente de designs complexos

5. **Versatilidade**
   - Vari√°veis dependentes cont√≠nuas ou categ√≥ricas
   - Diferentes distribui√ß√µes de probabilidade
   - Estruturas temporais variadas
:::

---

## üì¶ Pacotes Necess√°rios

```{r}
#| echo: true
#| message: false
#| warning: false

# Modelagem e an√°lise
library(lme4)        # Modelos lineares mistos
library(nlme)        # Modelos n√£o-lineares mistos
library(geepack)     # Equa√ß√µes de estima√ß√£o generalizadas

# M√©dias e compara√ß√µes
library(emmeans)     # M√©dias estimadas marginais
library(multcomp)    # Compara√ß√µes m√∫ltiplas
library(effects)     # Visualiza√ß√£o de efeitos

# Estat√≠sticas e diagn√≥sticos
library(performance) # Diagn√≥sticos de modelos
library(sjstats)     # Estat√≠sticas descritivas
library(rstatix)     # An√°lises simplificadas
library(car)         # Testes complementares

# Manipula√ß√£o de dados
library(dplyr)       # Transforma√ß√£o de dados
library(tidyr)       # Organiza√ß√£o de dados
library(foreign)     # Importa√ß√£o SPSS/Stata

# Visualiza√ß√£o
library(flexplot)    # Gr√°ficos flex√≠veis
library(see)         # Visualiza√ß√µes do easystats

# Suites integradas
library(easystats)   # Suite completa de an√°lise
library(rempsyc)     # M√©todos psicom√©tricos
```

---

## üì• Materiais para Download

::: {.callout-important}
## Arquivos Necess√°rios

Fa√ßa o download do pacote completo abaixo e **descompacte todos os arquivos na pasta do seu projeto**.

```{r}
#| echo: false
#| eval: false

xfun::embed_files(c('Lista 1.R', 
                    'bd_New drug_respiratory&pulse.sav', 
                    'lista_1.docx'))
```

**Conte√∫do do pacote:**

- `bd_New drug_respiratory&pulse.sav` - Banco de dados principal
- `Lista 1.R` - Script parcialmente preenchido para pr√°tica
- `lista_1.docx` - Exerc√≠cios para resolu√ß√£o
:::

---

## üîÑ Prepara√ß√£o dos Dados

### Carregamento Inicial

```{r}
#| echo: true
#| warning: false
#| message: false

# Importar dados do SPSS
original_wide <- read.spss("bd_New drug_respiratory&pulse.sav", 
                           to.data.frame = TRUE)

# Visualizar estrutura
head(original_wide)
```

::: {.callout-note collapse="true"}
## Sobre a fun√ß√£o `read.spss()`

- **Origem:** Pacote `foreign`
- **Par√¢metro `to.data.frame = TRUE`:** Converte para data frame do R
- **Alternativa:** Pacote `haven` com `read_sav()` (mais moderno)
:::

---

### Transforma√ß√£o Wide ‚Üí Long

Para an√°lises de medidas repetidas, precisamos converter os dados de formato **wide** (uma linha por sujeito) para **long** (uma linha por observa√ß√£o).

#### Passo 1: Renomear Colunas

```{r}
#| echo: true

bd <- original_wide %>%
  rename_with(~gsub("(resp|pulse)(\\d+)", "\\1_\\2", .), -drug) %>%
  mutate(ID = row_number()) %>%
  select(ID, everything())

head(bd)
```

::: {.callout-tip collapse="true"}
## üîç Entendendo a Express√£o Regular

A regex `(resp|pulse)(\\d+)` funciona assim:

- `(resp|pulse)` - Captura "resp" **OU** "pulse"
- `(\\d+)` - Captura um ou mais d√≠gitos

**Transforma√ß√£o:**
- `resp1` ‚Üí `resp_1`
- `pulse2` ‚Üí `pulse_2`

Isso facilita a separa√ß√£o posterior em vari√°vel e tempo!
:::

#### Passo 2: Pivotar para Formato Long

```{r}
#| echo: true

bd_long <- pivot_longer(
  bd,
  cols = resp_1:pulse_3,
  names_to = c(".value", "Tempo"),
  names_pattern = "(.+)_(.+)"
)

head(bd_long)
```

::: {.callout-note}
## Estrutura do `pivot_longer()`

- **`cols`:** Colunas a transformar
- **`.value`:** Nome da coluna vem da primeira parte
- **`Tempo`:** Criada da segunda parte do nome
- **`names_pattern`:** Regex para dividir nomes
:::

#### Passo 3: Converter Tempo em Fator

```{r}
#| echo: true

bd_long$Tempo <- factor(bd_long$Tempo)
```

---

## ‚úÖ Verifica√ß√£o de Pressupostos

### Normalidade da Vari√°vel Dependente

A distribui√ß√£o normal √© pressuposto fundamental em muitos testes estat√≠sticos.

::: {.panel-tabset}

#### Distribui√ß√£o Normal

```{r}
#| echo: true

set.seed(123)
dados_normais <- rnorm(1000, mean = 0, sd = 1)

# Criar visualiza√ß√µes
par(mfrow = c(1, 2))

# Histograma
hist(dados_normais, 
     main = "Distribui√ß√£o Normal",
     col = "lightblue", 
     border = "black")

# Q-Q Plot
qqnorm(dados_normais, main = "Q-Q Plot - Normal")
qqline(dados_normais, col = "red", lwd = 2)

par(mfrow = c(1, 1))
```

**Caracter√≠sticas:**
- Histograma em forma de sino
- Q-Q plot segue linha diagonal
- Simetria em torno da m√©dia

#### Distribui√ß√£o N√£o-Normal

```{r}
#| echo: true

set.seed(123)
dados_nao_normais <- abs(rnorm(1000, mean = 0, sd = 1))

par(mfrow = c(1, 2))

hist(dados_nao_normais,
     main = "Distribui√ß√£o Assim√©trica",
     col = "lightcoral",
     border = "black")

qqnorm(dados_nao_normais, main = "Q-Q Plot - N√£o Normal")
qqline(dados_nao_normais, col = "red", lwd = 2)

par(mfrow = c(1, 1))
```

**Caracter√≠sticas:**
- Assimetria evidente
- Desvios da linha no Q-Q plot
- Concentra√ß√£o em uma regi√£o

:::

---

### Teste de Shapiro-Wilk

::: {.callout-note}
## Hip√≥teses do Teste

**H‚ÇÄ:** Os dados seguem distribui√ß√£o normal  
**H‚ÇÅ:** Os dados N√ÉO seguem distribui√ß√£o normal

**Decis√£o:**
- p > 0,05 ‚Üí N√£o rejeita H‚ÇÄ (assume normalidade)
- p < 0,05 ‚Üí Rejeita H‚ÇÄ (evid√™ncia de n√£o-normalidade)

‚ö†Ô∏è **Aten√ß√£o:** Com amostras muito grandes, pequenos desvios podem ser significativos.
:::

**Exemplo com dados normais:**

```{r}
#| echo: true

shapiro.test(dados_normais)
```

**Exemplo com dados n√£o-normais:**

```{r}
#| echo: true

shapiro.test(dados_nao_normais)
```

---

### Normalidade das Vari√°veis do Estudo

#### Vari√°vel "Pulse"

```{r}
#| echo: true

# Visualiza√ß√£o combinada
nice_normality(
  data = bd_long,
  variable = "pulse",
  histogram = TRUE
)

# Teste formal
shapiro.test(bd_long$pulse)
```

::: {.callout-warning}
## Interpreta√ß√£o

Tanto a an√°lise gr√°fica quanto o teste de Shapiro-Wilk indicam que **pulse n√£o possui distribui√ß√£o normal**.
:::

---

## üîÑ Esfericidade (Medidas Repetidas)

::: {.callout-important}
## O que √© Esfericidade?

A **esfericidade** avalia se as vari√¢ncias das diferen√ßas entre todos os pares de medidas repetidas s√£o homog√™neas.

**Viola√ß√£o de esfericidade:**
- Infla erro Tipo I (falsos positivos)
- Requer corre√ß√µes nos graus de liberdade
- Comum em medidas repetidas
:::

### Teste de Mauchly para "Pulse"

```{r}
#| echo: true

pulse_mauchly <- anova_test(
  data = bd_long,
  dv = pulse,
  wid = ID,
  within = Tempo
)

pulse_mauchly
```

::: {.callout-tip collapse="true"}
## üìä Interpretando os Resultados

**ANOVA Table:**
- **F** = 3,48, **p** = 0,049 ‚Üí Efeito significativo de Tempo
- **ges** = medida de tamanho de efeito

**Teste de Mauchly:**
- **W** = 0,781, **p** = 0,29 ‚Üí Esfericidade N√ÉO violada

**Corre√ß√µes (quando necess√°rias):**
- **GGe** = 0,82 ‚Üí Corre√ß√£o de Greenhouse-Geisser
- **HFe** = 0,945 ‚Üí Corre√ß√£o de Huynh-Feldt
:::

---

### Teste de Mauchly para "Resp"

```{r}
#| echo: true

resp_mauchly <- anova_test(
  data = bd_long,
  dv = resp,
  wid = ID,
  within = Tempo
)

resp_mauchly
```

::: {.callout-warning}
## ‚ö†Ô∏è Esfericidade Violada!

**Teste de Mauchly:**
- **W** = 0,501, **p** < 0,05 ‚Üí Esfericidade VIOLADA

**Implica√ß√µes:**
- Graus de liberdade devem ser corrigidos
- Usar valores p corrigidos (GGe ou HFe)
- GGe = 0,667 (redu√ß√£o de ~33%)
- HFe = 0,725 (redu√ß√£o de ~27,5%)

**Resultado ap√≥s corre√ß√£o:**
- Efeito de Tempo permanece n√£o-significativo
:::

---

## üîß Coeficientes de Corre√ß√£o

::: {.panel-tabset}

### Greenhouse-Geisser (GGe)

**Caracter√≠sticas:**
- Corre√ß√£o mais conservadora
- Recomendado quando GGe < 0,75
- Reduz graus de liberdade proporcionalmente

**Interpreta√ß√£o:**
- GGe pr√≥ximo de 1 ‚Üí Pouca viola√ß√£o
- GGe < 0,75 ‚Üí Viola√ß√£o substancial

**Exemplo (Resp):**
- GGe = 0,667 ‚Üí Redu√ß√£o de 33% nos GL

### Huynh-Feldt (HFe)

**Caracter√≠sticas:**
- Menos conservador que GGe
- Melhor para amostras pequenas
- Pode exceder 1 (truncado em 1)

**Interpreta√ß√£o:**
- HFe pr√≥ximo de 1 ‚Üí Pouca viola√ß√£o
- Diferen√ßa com GGe indica severidade

**Exemplo (Resp):**
- HFe = 0,725 ‚Üí Redu√ß√£o de 27,5% nos GL

### Quando Usar Qual?

| Situa√ß√£o | Recomenda√ß√£o |
|----------|--------------|
| GGe > 0,75 | Qualquer corre√ß√£o |
| GGe < 0,75 | Preferir GGe |
| Amostra pequena | Considerar HFe |
| p pr√≥ximo de 0,05 | Comparar ambos |

:::

---

## üéì Resumo dos Pressupostos

::: {.callout-note appearance="simple"}
## Checklist de Verifica√ß√£o

| Pressuposto | Pulse | Resp | A√ß√£o |
|-------------|-------|------|------|
| Normalidade | ‚ùå Violado | - | Considerar transforma√ß√£o ou GLM robusto |
| Esfericidade | ‚úÖ OK | ‚ùå Violado | Usar corre√ß√µes GGe/HFe |
| Homogeneidade | - | - | Verificar com Levene (pr√≥ximo cap√≠tulo) |

**Pr√≥ximos passos:** Agora que verificamos os pressupostos, podemos prosseguir para as an√°lises GLM, GEE e GMM!
:::

---

## üìö Conceitos-Chave

::: {.callout-tip collapse="true"}
## Gloss√°rio R√°pido

**Wide vs Long:**
- Wide: Uma linha por sujeito, m√∫ltiplas colunas de tempo
- Long: Uma linha por observa√ß√£o, coluna de tempo

**Esfericidade:**
- Homogeneidade das vari√¢ncias das diferen√ßas
- Cr√≠tico para ANOVA de medidas repetidas

**GGe/HFe:**
- Corre√ß√µes para viola√ß√£o de esfericidade
- Ajustam graus de liberdade

**Q-Q Plot:**
- Quantis observados vs esperados
- Linha diagonal = normalidade perfeita
:::

---

::: {.callout-note appearance="simple"}
## üöÄ Pronto para An√°lises!

Com os dados preparados e pressupostos verificados, voc√™ est√° pronto para explorar:

1. **GLM** - Modelo Linear Geral
2. **GEE** - Equa√ß√µes de Estima√ß√£o Generalizadas  
3. **GMM** - Modelos Mistos
4. **GzLM** - Modelos Lineares Generalizados

Siga para os pr√≥ximos cap√≠tulos onde implementaremos cada modelo em detalhe!
:::