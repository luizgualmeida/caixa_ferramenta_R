# Lista 6: AnÃ¡lise de Sobrevida {#sec-lista-6 .unnumbered}

::: {.callout-note appearance="simple" icon=false}
## Objetivo da Lista

Aprenda tÃ©cnicas de **anÃ¡lise de sobrevida**: construir curvas de **Kaplan-Meier**, comparar grupos com **testes log-rank** e modelar riscos com **RegressÃ£o de Cox**. Trabalharemos com dados reais de 124 pacientes na fila de transplante renal.
:::

---

## ğŸ“– Contexto do Estudo

::: {.callout-tip}
## Dados: Fila de Transplante Renal

**Amostra:** 124 pacientes aguardando transplante de rim

**VariÃ¡veis:**
- `t_seg`: Tempo de seguimento (meses)
- `tx`: Realizou transplante? (sim/nÃ£o)
- `obito`: Ã“bito do paciente (sim/nÃ£o) - **evento de interesse**
- `t_tx`: Tempo atÃ© o transplante (meses)

**Pergunta:** O transplante afeta a sobrevida dos pacientes?
:::

---

## ğŸ“¦ Pacotes necessÃ¡rios

```{r}
#| echo: true
#| message: false
#| warning: false

pacotes <- c(
  "tidyverse", "foreign", "ggplot2", "kableExtra",
  "survival", "ggsurvfit", "survminer", "broom",
  "gtsummary", "report", "coin"
)

pacotes_faltantes <- pacotes[!pacotes %in% installed.packages()[, "Package"]]
if (length(pacotes_faltantes) > 0) {
  install.packages(pacotes_faltantes, dependencies = TRUE)
}

invisible(lapply(pacotes, library, character.only = TRUE))
cat("âœ“ Pacotes de sobrevida carregados!\n")
```

---

## ğŸ§¹ Boas PrÃ¡ticas: Ambiente Limpo

```{r}
#| echo: true

# Limpar ambiente
rm(list = ls(all.names = TRUE))
gc()

# ConfiguraÃ§Ãµes
options(max.print = .Machine$integer.max, 
        scipen = 999, 
        stringsAsFactors = FALSE)

set.seed(42)
```

---

## ğŸ¨ Tema Customizado (Opcional)

```{r}
#| echo: true

meu_tema <- theme(
  plot.title = element_text(size = rel(1.5), face = "bold"),
  panel.grid.major.y = element_line(colour = 'gray90'),
  panel.grid.minor.y = element_line(colour = 'gray95'),
  panel.grid.major.x = element_blank(),
  panel.grid.minor.x = element_blank(),
  plot.background = element_rect(fill = 'white', colour = 'white'),
  panel.background = element_rect(fill = 'white'),
  axis.line = element_line(colour = 'black', linewidth = 0.8),
  axis.text = element_text(colour = "black", face = 'bold'),
  axis.title = element_text(size = rel(1.2)),
  axis.ticks = element_line(colour = 'black', linewidth = 0.8),
  legend.position = "bottom",
  legend.background = element_blank(),
  legend.box.background = element_rect(colour = "black")
)
```

---

## ğŸ“¥ PreparaÃ§Ã£o dos Dados

```{r}
#| echo: true
#| message: false
#| warning: false

# Carregar
original <- read.spss("teste Cox tempo dep Tx.sav", to.data.frame = TRUE)

glimpse(original)
```

---

### âš ï¸ ConversÃ£o CrÃ­tica: Evento BinÃ¡rio

::: {.callout-important}
## Regra Fundamental!

A variÃ¡vel de **evento** DEVE ser **numÃ©rica binÃ¡ria** (0 = censura, 1 = evento).

**NÃ£o use:** Fatores "sim"/"nÃ£o"  
**Use:** 0 = sem Ã³bito (censurado), 1 = com Ã³bito (evento)
:::

```{r}
#| echo: true

# Criar versÃ£o corrigida
db <- original %>%
  mutate(obito = as.integer(obito == "sim"))

# Verificar
glimpse(db$obito)
table(db$obito)
```

---

### AnÃ¡lise ExploratÃ³ria

```{r}
#| echo: true

# Verificar missing values
data.frame(
  NA_t_seg = sum(is.na(db$t_seg)),
  NA_t_tx = sum(is.na(db$t_tx)),
  NA_tx = sum(is.na(db$tx)),
  NA_obito = sum(is.na(db$obito))
) %>% kable(caption = "Dados Faltantes")
```

::: {.callout-note collapse="true"}
## ğŸ“Š Interpretando NAs em t_tx

**51.6% de NAs** em `t_tx` Ã© **esperado**! Representa pacientes que **nÃ£o** fizeram transplante.

**VerificaÃ§Ã£o:** Nenhum paciente com tx="sim" deveria ter NA em t_tx.

```{r}
#| echo: true

# Verificar inconsistÃªncias
db %>% filter(tx == "sim" & is.na(t_tx))
```

Se retornar 0 linhas â†’ OK!
:::

---

## ğŸ¯ Estrutura de Dados de Sobrevida

```{r}
#| echo: true

# Criar objeto Surv
surv_obj <- Surv(time = db$t_seg, event = db$obito)

# Visualizar primeiros casos
head(surv_obj)
```

::: {.callout-tip}
## ğŸ” Interpretando a NotaÃ§Ã£o

- **34:** Tempo 34, evento ocorreu
- **58+:** Tempo 58, **censurado** (+ indica censura)

**Censura** = paciente saiu do estudo sem evento (perdeu acompanhamento, fim do estudo, etc.)
:::

---

## ğŸ“Š Parte A: TÃ¡bua de Vida

```{r}
#| echo: true

# Modelo geral (sem grupos)
fit1 <- survfit(surv_obj ~ 1, data = db)

# Resumo
summary(fit1)
```

---

### Tabela Formatada

```{r}
#| echo: true

tidy_survfit(fit1) %>%
  head(10) %>%
  kable(digits = 3, caption = "Primeiras 10 Linhas da TÃ¡bua de Vida")
```

---

## ğŸ“ˆ Parte B: Curva de Kaplan-Meier

### Curva Geral

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 6

ggsurvfit(fit1, linewidth = 1.2) +
  labs(
    title = "Curva de Sobrevida Geral",
    x = "Tempo (meses)",
    y = "Probabilidade de Sobrevida"
  ) +
  add_confidence_interval(alpha = 0.2) +
  add_risktable() +
  scale_ggsurvfit() +
  theme_minimal()
```

---

### Comparando Grupos: Transplante vs NÃ£o-Transplante

```{r}
#| echo: true

# Modelo com grupos
fit2 <- survfit(surv_obj ~ tx, data = db)

# Resumo em tempos especÃ­ficos
tempos <- seq(0, 100, by = 20)
summary(fit2, times = tempos)
```

---

### VisualizaÃ§Ã£o Comparativa

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 7

fit2_km <- ggsurvfit(fit2, linewidth = 1.2) +
  labs(
    title = "Sobrevida: Transplante vs NÃ£o-Transplante",
    x = "Tempo (meses)",
    y = "Probabilidade de Sobrevida (%)"
  ) +
  add_confidence_interval(alpha = 0.2) +
  add_risktable() +
  scale_ggsurvfit() +
  theme_minimal()

fit2_km
```

---

### AnÃ¡lise em Tempo EspecÃ­fico

```{r}
#| echo: true

# Sobrevida aos 75 meses
surv_75 <- summary(fit2, times = 75)

cat("â•â•â• SOBREVIDA AOS 75 MESES â•â•â•\n\n")
cat("Transplante = SIM:\n")
cat("  Sobrevida:", round(surv_75$surv[1], 3), "\n")
cat("  IC 95%: [", round(surv_75$lower[1], 3), ",",
    round(surv_75$upper[1], 3), "]\n\n")

cat("Transplante = NÃƒO:\n")
cat("  Sobrevida:", round(surv_75$surv[2], 3), "\n")
cat("  IC 95%: [", round(surv_75$lower[2], 3), ",",
    round(surv_75$upper[2], 3), "]\n\n")

# RazÃ£o
razao <- surv_75$surv[1] / surv_75$surv[2]
cat("RazÃ£o (Sim/NÃ£o):", round(razao, 2), "Ã—\n")
cat("â†’ Grupo com transplante tem", round(razao, 2), 
    "Ã— mais chance de estar vivo aos 75 meses\n")
```

---

### GrÃ¡fico com MarcaÃ§Ã£o de Tempo

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 6

fit2_km +
  geom_vline(xintercept = 75, linetype = 'dashed', 
             colour = 'red', linewidth = 1) +
  geom_hline(yintercept = surv_75$surv, linetype = 'dashed',
             colour = 'red', linewidth = 1) +
  annotate("text", x = 77, y = 0.9, label = "75 meses",
           hjust = 0, color = "red", fontface = "bold")
```

---

### Percentil Fixo: Tempo para 75% de Sobrevida

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 6

fit2 %>%
  ggsurvfit(linewidth = 1.2) +
  labs(
    title = "Tempo atÃ© 75% de Sobrevida",
    x = "Tempo (meses)",
    y = "Probabilidade de Sobrevida"
  ) +
  add_confidence_interval(alpha = 0.2) +
  add_quantile(y_value = 0.75, color = "gray30", linewidth = 0.8) +
  scale_ggsurvfit() +
  theme_minimal()
```

::: {.callout-note}
## ğŸ“Š InterpretaÃ§Ã£o

- **Sem transplante:** Atinge 75% de sobrevida ~35 meses
- **Com transplante:** Atinge 75% de sobrevida ~90 meses

Transplante **mais que dobra** o tempo para atingir esse patamar!
:::

---

## ğŸ”¬ ComparaÃ§Ã£o de Curvas: Testes EstatÃ­sticos

::: {.callout-tip}
## Escolhendo o Teste Certo

- **Log-rank:** DiferenÃ§as ao longo de **todo** o perÃ­odo (padrÃ£o)
- **Gehan-Breslow:** Enfatiza diferenÃ§as **iniciais**
- **Tarone-Ware:** Peso intermediÃ¡rio
- **Peto-Peto:** Similar ao log-rank, robusto

**Regra geral:** Use log-rank a menos que haja razÃ£o especÃ­fica.
:::

---

### Log-Rank (Mantel-Cox)

```{r}
#| echo: true

logrank_test(surv_obj ~ tx, data = db, type = "logrank")
```

---

### Gehan-Breslow

```{r}
#| echo: true

logrank_test(surv_obj ~ tx, data = db, type = "Gehan-Breslow")
```

---

### Tarone-Ware

```{r}
#| echo: true

logrank_test(surv_obj ~ tx, data = db, type = "Tarone-Ware")
```

---

::: {.callout-note}
## ğŸ“Š ConclusÃ£o dos Testes

Todos os testes indicam **p < 0.05**, rejeitando Hâ‚€.

**ConclusÃ£o:** HÃ¡ evidÃªncia significativa de que as curvas de sobrevida diferem entre grupos com e sem transplante.
:::

---

## ğŸ¯ Parte C: RegressÃ£o de Cox

::: {.callout-tip}
## O que Ã© RegressÃ£o de Cox?

Modelo **semi-paramÃ©trico** que estima o **risco instantÃ¢neo** (hazard) de um evento ao longo do tempo.

**Vantagens:**
- Permite mÃºltiplas covariÃ¡veis
- NÃ£o assume distribuiÃ§Ã£o especÃ­fica do tempo
- Estima **Hazard Ratios** (HR)

**HR interpretaÃ§Ã£o:**
- HR = 1: Sem efeito
- HR > 1: Aumenta risco
- HR < 1: Diminui risco (proteÃ§Ã£o)
:::

---

### Ajuste do Modelo

```{r}
#| echo: true

# Modelo Cox
cox_res <- coxph(surv_obj ~ tx, data = db)

# Resumo
summary(cox_res)
```

---

### Tabela Formatada para PublicaÃ§Ã£o

```{r}
#| echo: true

tbl_regression(
  cox_res,
  exponentiate = TRUE,
  label = list(tx ~ "Transplante")
) %>%
  bold_p() %>%
  add_global_p()
```

::: {.callout-note}
## ğŸ“Š InterpretaÃ§Ã£o

**HR = 2.94** para tx="nÃ£o"

"Pacientes **sem transplante** tÃªm **2.94Ã— mais risco** de Ã³bito comparado aos que fizeram transplante"

Equivalente: Transplante **reduz risco em 66%** [(1 - 1/2.94) Ã— 100]
:::

---

### Curvas Ajustadas pelo Modelo

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 6

# Prever para ambos os grupos
tx_df <- data.frame(tx = c("sim", "nÃ£o"))
cox_pred <- survfit(cox_res, newdata = tx_df)

ggsurvplot(
  cox_pred,
  data = db,
  conf.int = TRUE,
  legend.labs = c("Transplante = Sim", "Transplante = NÃ£o"),
  ggtheme = theme_minimal(),
  title = "Curvas de Sobrevida Ajustadas (Modelo Cox)"
)
```

::: {.callout-warning}
## âš ï¸ Cox vs Kaplan-Meier

As curvas do **modelo Cox** sÃ£o **ajustadas** e podem diferir ligeiramente das curvas Kaplan-Meier **empÃ­ricas**. Isso Ã© normal!

- **K-M:** Dados brutos, nÃ£o-paramÃ©trico
- **Cox:** Modelo ajustado, assume proporcionalidade
:::

---

### Forest Plot do Modelo

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 4

ggforest(cox_res, data = db)
```

---

## ğŸ“ Parte D: Calculando Hazard Ratio em Tempo EspecÃ­fico

```{r}
#| echo: true

# Especificando o modelo 

cox_res <- coxph(Surv(time = t_seg, event = obito) ~ tx, data = db)

# Criar dados para prediÃ§Ã£o (tempo 50 meses)
pred_dat <- data.frame(t_seg = c(50,50),
                       obito = c(0,0), 
                       tx = c("sim","nÃ£o")
                       )

kable(pred_dat)
```


```{r}
#| echo: true

# Prever sobrevida
preds <- predict(cox_res,
                 pred_dat, 
                 type = "survival", 
                 se.fit = TRUE)

# Adicionar ao dataframe
pred_dat$prob <- preds$fit
pred_dat$lcl <- preds$fit - 1.96 * preds$se.fit
pred_dat$ucl <- preds$fit + 1.96 * preds$se.fit

# Exibir
kable(pred_dat, digits = 3, caption = "Sobrevida Predita aos 50 meses")

# HR
HR_50 <- pred_dat$prob[1] / pred_dat$prob[2]
cat("\nHR aos 50 meses:", round(HR_50, 3), "\n")
cat("â†’ Grupo com transplante tem", round(HR_50, 2), 
    "Ã— mais sobrevida que grupo sem transplante\n")
```

---

### HR em MÃºltiplos Tempos

```{r}
#| echo: true

# MÃºltiplos tempos
tempos_interesse <- c(30, 50, 75, 90)
resultados_hr <- data.frame()

for (t in tempos_interesse) {
  pred_temp <- data.frame(
    t_seg = c(t, t),
    obito = c(0, 0),
    tx = c("sim", "nÃ£o")
  )
  
  preds_temp <- predict(cox_res, newdata = pred_temp, 
                        type = "survival", se.fit = TRUE)
  
  hr <- preds_temp$fit[1] / preds_temp$fit[2]
  
  resultados_hr <- rbind(resultados_hr, data.frame(
    Tempo = t,
    Sobrevida_Sim = round(preds_temp$fit[1], 3),
    Sobrevida_NÃ£o = round(preds_temp$fit[2], 3),
    HR = round(hr, 3)
  ))
}

kable(resultados_hr, caption = "Hazard Ratios ao Longo do Tempo")
```

---

## âœ… VerificaÃ§Ã£o de Pressupostos

::: {.callout-important}
## Pressuposto Principal: Proporcionalidade dos Riscos

O modelo Cox assume que o **hazard ratio Ã© constante** ao longo do tempo.

**ViolaÃ§Ã£o:** Se HR muda com o tempo, use modelo estratificado ou tempo-dependente.
:::

---

### 1. InspeÃ§Ã£o Visual: Curvas Paralelas?

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 6

fit2_km +
  labs(subtitle = "Curvas paralelas? â†’ Riscos proporcionais âœ“")
```

::: {.callout-note}
Se curvas **cruzam**, hÃ¡ violaÃ§Ã£o! Neste caso, sÃ£o aproximadamente paralelas â†’ OK.
:::

---

### 2. Teste de Schoenfeld

```{r}
#| echo: true

# Teste formal
test_schoenfeld <- cox.zph(cox_res)
print(test_schoenfeld)
```

::: {.callout-tip}
## Interpretando o Teste

**Hâ‚€:** Riscos sÃ£o proporcionais  
**p > 0.05:** NÃ£o rejeitamos Hâ‚€ â†’ Proporcionalidade mantida âœ“

**Neste caso:** p = 0.43 â†’ Pressuposto atendido!
:::

---

### GrÃ¡fico de ResÃ­duos

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 6

ggcoxzph(test_schoenfeld, point.size = 0.5)
```

::: {.callout-note collapse="true"}
## ğŸ” Interpretando ResÃ­duos de Schoenfeld

**O que procurar:**
- **Sem padrÃ£o:** ResÃ­duos aleatÃ³rios ao redor de zero â†’ Bom!
- **TendÃªncia linear:** ViolaÃ§Ã£o da proporcionalidade
- **PadrÃ£o nÃ£o-linear:** ViolaÃ§Ã£o severa

**Linha de suavizaÃ§Ã£o:**
- Aproximadamente horizontal â†’ Proporcionalidade OK
- InclinaÃ§Ã£o clara â†’ Problema!
:::

---

## ğŸ“š Material Complementar

{{< video https://www.youtube.com/watch?v=oyhA4EiE1eM title='AnÃ¡lise Sobrevida I - Kaplan-Meier e Cox - Aula PrÃ¡tica #6' >}}

---

## ğŸ”§ InformaÃ§Ãµes de SessÃ£o

```{r}
report(sessionInfo())
```

---

::: {.callout-note appearance="simple"}
## ğŸ“ Resumo da Lista 6

Nesta lista vocÃª:

âœ… Construiu **tÃ¡buas de vida** e curvas **Kaplan-Meier**  
âœ… Comparou grupos com **testes log-rank**  
âœ… Ajustou **RegressÃ£o de Cox** e interpretou **Hazard Ratios**  
âœ… Calculou HR em **tempos especÃ­ficos**  
âœ… Verificou **proporcionalidade dos riscos**  

**Conceitos-chave:**
- Censura: dado incompleto (nÃ£o Ã© perda de dados!)
- K-M: mÃ©todo nÃ£o-paramÃ©trico para sobrevida
- Cox: modelo semi-paramÃ©trico para riscos
- HR: razÃ£o de riscos instantÃ¢neos
- Proporcionalidade: HR constante ao longo do tempo

**PrÃ³ximos passos:**
- Lista 7: Cox com covariÃ¡veis **tempo-dependentes**
- Explorar modelos com mÃºltiplas covariÃ¡veis
- AnÃ¡lises estratificadas para violaÃ§Ãµes de proporcionalidade
:::