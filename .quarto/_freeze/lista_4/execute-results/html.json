{
  "hash": "fd7355ff81f12a4abaae5db1eea8ae89",
  "result": {
    "engine": "knitr",
    "markdown": "# Lista 4: Modelos Hier√°rquicos e ICC {.unnumbered}\n\n::: {.callout-note appearance=\"simple\" icon=false}\n## Objetivo da Lista\n\nAprenda a trabalhar com **modelos hier√°rquicos de 3 n√≠veis** (alunos ‚Üí classes ‚Üí escolas) e utilize o **ICC** para decidir quais vari√°veis devem ser efeitos aleat√≥rios.\n:::\n\n---\n\n## üìñ Contexto: Estudo TVSFP\n\n::: {.callout-tip collapse=\"true\"}\n## Television, School and Family Smoking Prevention Project\n\n**Objetivo:** Avaliar efic√°cia de programas anti-tabagismo\n\n**Interven√ß√µes:**\n- **CC:** Curr√≠culo presencial\n- **TV:** Programa televisivo\n\n**4 Grupos:** Curriculum&TV, Curriculum, TV, Neither (controle)\n\n**Amostra:** 1.600 alunos, 135 classes, 28 escolas (Los Angeles)\n\n**VD:** THKS (Tobacco and Health Knowledge Scale) pr√© e p√≥s\n:::\n\n---\n\n## üì¶ Pacotes\n\n\n\n\n\n\n\n\n::: {.cell}\n\n:::\n\n\n\n\n\n\n\n\n---\n\n## üì• Dados\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndataset <- read.spss(\"THKS2.sav\", to.data.frame = TRUE)\n\n# Corrigir tipos\ndataset$SchoolID <- as.factor(dataset$SchoolID)\ndataset$ClassID <- as.factor(dataset$ClassID)\ndataset$PreTHKS <- as.integer(dataset$PreTHKS)\ndataset$PosTHKS <- as.integer(dataset$PosTHKS)\ndataset$Tamanho_Classe <- ave(dataset$PreTHKS, dataset$SchoolID, dataset$ClassID, FUN = length)\n```\n:::\n\n\n\n\n\n\n\n\n---\n\n## üéØ Parte A: An√°lise Visual dos N√≠veis\n\n### Por Escola\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmedia_escola <- aggregate(cbind(PreTHKS, PosTHKS) ~ SchoolID, data = dataset, FUN = mean)\nmedia_escola_long <- pivot_longer(media_escola, cols = c(\"PreTHKS\", \"PosTHKS\"), names_to = \"tempo\", values_to = \"media\")\n\nggplot(media_escola_long, aes(x = fct_rev(tempo), y = media, color = SchoolID, group = SchoolID)) +\n  geom_point(size = 3) + geom_line() +\n  labs(title = \"Trajet√≥ria por Escola\", x = \"\", y = \"M√©dia THKS\") +\n  theme_minimal() + theme(legend.position = \"right\")\n```\n\n::: {.cell-output-display}\n![](lista_4_files/figure-html/unnamed-chunk-3-1.png){width=960}\n:::\n:::\n\n\n\n\n\n\n\n\n**Padr√£o:** Aumento consistente ‚Üí Escola = efeito fixo?\n\n---\n\n### Por Classe\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmedia_classe <- aggregate(cbind(PreTHKS, PosTHKS) ~ ClassID, data = dataset, FUN = mean)\nmedia_classe_long <- pivot_longer(media_classe, cols = c(\"PreTHKS\", \"PosTHKS\"), names_to = \"tempo\", values_to = \"media\")\n\nggplot(media_classe_long, aes(x = fct_rev(tempo), y = media, color = ClassID, group = ClassID)) +\n  geom_point(size = 2) + geom_line(alpha = 0.4) +\n  labs(title = \"Trajet√≥ria por Classe (135 classes)\", x = \"\", y = \"M√©dia THKS\") +\n  theme_minimal() + theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](lista_4_files/figure-html/unnamed-chunk-4-1.png){width=960}\n:::\n:::\n\n\n\n\n\n\n\n\n**Padr√£o:** Heterog√™neo ‚Üí Classe = efeito aleat√≥rio!\n\n---\n\n## üéØ Parte D: ICC\n\n### Modelo 1: Com Preditores\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodelo_1 <- lmer(PosTHKS ~ 1 + Group * PreTHKS + (1|SchoolID:ClassID) + (1|SchoolID), data = dataset, REML = TRUE)\nvar_modelo_1 <- as.data.frame(VarCorr(modelo_1))\n\nvar_classe_1 <- var_modelo_1$vcov[1]\nvar_escola_1 <- var_modelo_1$vcov[2]\nvar_erro_1 <- var_modelo_1$vcov[3]\n\nicc_escola_1 <- var_escola_1 / (var_escola_1 + var_erro_1)\nicc_classe_1 <- var_classe_1 / (var_classe_1 + var_erro_1)\n\ncat(\"ICC Escola:\", round(icc_escola_1, 4), \"=\", round(icc_escola_1 * 100, 2), \"%\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nICC Escola: 0.0235 = 2.35 %\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"ICC Classe:\", round(icc_classe_1, 4), \"=\", round(icc_classe_1 * 100, 2), \"%\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nICC Classe: 0.0389 = 3.89 %\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n---\n\n### Modelo 2: Apenas Aleat√≥rios\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodelo_2 <- lmer(PosTHKS ~ 1 + (1|SchoolID:ClassID) + (1|SchoolID), data = dataset, REML = TRUE)\nvar_modelo_2 <- as.data.frame(VarCorr(modelo_2))\n\nicc_escola_2 <- var_modelo_2$vcov[2] / (var_modelo_2$vcov[2] + var_modelo_2$vcov[3])\nicc_classe_2 <- var_modelo_2$vcov[1] / (var_modelo_2$vcov[1] + var_modelo_2$vcov[3])\n\ncat(\"ICC Escola:\", round(icc_escola_2, 4), \"=\", round(icc_escola_2 * 100, 2), \"%\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nICC Escola: 0.0634 = 6.34 %\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"ICC Classe:\", round(icc_classe_2, 4), \"=\", round(icc_classe_2 * 100, 2), \"%\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nICC Classe: 0.047 = 4.7 %\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n::: {.callout-note}\nEscola passa de <5% para >5% sem preditores!\n:::\n\n\n---\n\n## üéØ Parte E: Modelo Final\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndataset$Group <- relevel(dataset$Group, ref = \"Neither\")\n\nmodelo_final <- lme(\n  fixed = PosTHKS ~ 1 + PreTHKS + Group,\n  random = ~1|SchoolID/ClassID,\n  data = dataset,\n  method = \"REML\"\n)\n```\n:::\n\n\n\n\n\n\n\n\n### Diagn√≥stico\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncheck_model(modelo_final)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nConverting missing values (`NA`) into regular values currently not\n  possible for variables of class `NULL`.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](lista_4_files/figure-html/unnamed-chunk-8-1.png){width=1152}\n:::\n:::\n\n\n\n\n\n\n\n\n### Compara√ß√µes\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncomparacoes <- emmeans(modelo_final, pairwise ~ Group, adjust = \"bonferroni\")\ncomparacoes$contrasts\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n contrast                     estimate    SE df t.ratio p.value\n Neither - Curriculum & TV      -0.492 0.159 24  -3.104  0.0290\n Neither - Curriculum           -0.641 0.161 24  -3.985  0.0033\n Neither - TV                   -0.182 0.157 24  -1.158  1.0000\n Curriculum & TV - Curriculum   -0.149 0.160 24  -0.928  1.0000\n Curriculum & TV - TV            0.310 0.157 24   1.981  0.3550\n Curriculum - TV                 0.459 0.159 24   2.888  0.0485\n\nDegrees-of-freedom method: containment \nP value adjustment: bonferroni method for 6 tests \n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n### Visualiza√ß√£o\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmeans_plot <- as.data.frame(comparacoes$emmeans)\n\nggplot(means_plot, aes(x = reorder(Group, -emmean), y = emmean, fill = Group)) +\n  geom_col(alpha = 0.8) +\n  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.2) +\n  labs(title = \"THKS P√≥s-Interven√ß√£o por Grupo\", y = \"THKS Estimado\") +\n  theme_minimal() + theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](lista_4_files/figure-html/unnamed-chunk-10-1.png){width=960}\n:::\n:::\n\n\n\n\n\n\n\n\n---\n\n## üîß Extras\n\n### Fun√ß√£o ICC Personalizada\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nicc_lme_3nv <- function(modelo) {\n  var_escola <- as.numeric(VarCorr(modelo)[2, \"Variance\"])\n  var_classe <- as.numeric(VarCorr(modelo)[4, \"Variance\"])\n  var_res <- as.numeric(VarCorr(modelo)[5, \"Variance\"])\n  \n  list(\n    ICC_Escola = var_escola / (var_escola + var_res),\n    ICC_Classe = var_classe / (var_classe + var_res)\n  )\n}\n\nicc_lme_3nv(modelo_final)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n$ICC_Escola\n[1] 0.02354758\n\n$ICC_Classe\n[1] 0.03879018\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n### Compara√ß√£o Modelos\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncompare_performance(modelo_1, modelo_2, metrics = c(\"AIC\", \"BIC\"), rank = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# Comparison of Model Performance Indices\n\nName     |   Model | AIC weights | BIC weights | Performance-Score\n------------------------------------------------------------------\nmodelo_1 | lmerMod |        1.00 |        1.00 |           100.00%\nmodelo_2 | lmerMod |    2.80e-30 |    4.19e-22 |             0.00%\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n---\n\n## üìö Material Complementar\n\n\n\n\n\n\n\n\n{{< video https://www.youtube.com/watch?v=_1lUvEu8M9c title='HGMM - Aula Pr√°tica #4 (SPSS)' >}}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n---\n\n## üîß Sess√£o\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nreport(sessionInfo())\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAnalyses were conducted using the R Statistical language (version 4.4.2; R Core\nTeam, 2024) on Windows 11 x64 (build 26100), using the packages lme4 (version\n1.1.37; Bates D et al., 2015), Matrix (version 1.7.1; Bates D et al., 2024),\neffectsize (version 1.0.1; Ben-Shachar MS et al., 2020), flexplot (version\n0.24.3; Fife, D, 2022), emmeans (version 1.11.0; Lenth R, 2025), parameters\n(version 0.28.3; L√ºdecke D et al., 2020), performance (version 0.15.2; L√ºdecke\nD et al., 2021), easystats (version 0.7.5; L√ºdecke D et al., 2022), see\n(version 0.12.0; L√ºdecke D et al., 2021), insight (version 1.4.4; L√ºdecke D et\nal., 2019), bayestestR (version 0.17.0; Makowski D et al., 2019), modelbased\n(version 0.13.1; Makowski D et al., 2025), report (version 0.6.3; Makowski D et\nal., 2023), correlation (version 0.8.8; Makowski D et al., 2022), datawizard\n(version 1.3.0; Patil I et al., 2022), nlme (version 3.1.166; Pinheiro J et\nal., 2024), foreign (version 0.8.87; R Core Team, 2024), ggplot2 (version\n4.0.1; Wickham H, 2016), forcats (version 1.0.0; Wickham H, 2023), dplyr\n(version 1.1.4; Wickham H et al., 2023), tidyr (version 1.3.1; Wickham H et\nal., 2024), misty (version 0.7.6; Yanagida T, 2025) and kableExtra (version\n1.4.0; Zhu H, 2024).\n\nReferences\n----------\n  - Bates D, M√§chler M, Bolker B, Walker S (2015). \"Fitting Linear Mixed-Effects\nModels Using lme4.\" _Journal of Statistical Software_, *67*(1), 1-48.\ndoi:10.18637/jss.v067.i01 <https://doi.org/10.18637/jss.v067.i01>.\n  - Bates D, Maechler M, Jagan M (2024). _Matrix: Sparse and Dense Matrix Classes\nand Methods_. R package version 1.7-1,\n<https://CRAN.R-project.org/package=Matrix>.\n  - Ben-Shachar MS, L√ºdecke D, Makowski D (2020). \"effectsize: Estimation of\nEffect Size Indices and Standardized Parameters.\" _Journal of Open Source\nSoftware_, *5*(56), 2815. doi:10.21105/joss.02815\n<https://doi.org/10.21105/joss.02815>, <https://doi.org/10.21105/joss.02815>.\n  - Fife, A. D (2022). \"Flexplot: Graphically-based data analysis.\"\n_Psychological Methods_, *27*(4), -19. <doi.org/10.1037/met0000424>.\n  - Lenth R (2025). _emmeans: Estimated Marginal Means, aka Least-Squares Means_.\nR package version 1.11.0, <https://CRAN.R-project.org/package=emmeans>.\n  - L√ºdecke D, Ben-Shachar M, Patil I, Makowski D (2020). \"Extracting, Computing\nand Exploring the Parameters of Statistical Models using R.\" _Journal of Open\nSource Software_, *5*(53), 2445. doi:10.21105/joss.02445\n<https://doi.org/10.21105/joss.02445>.\n  - L√ºdecke D, Ben-Shachar M, Patil I, Waggoner P, Makowski D (2021).\n\"performance: An R Package for Assessment, Comparison and Testing of\nStatistical Models.\" _Journal of Open Source Software_, *6*(60), 3139.\ndoi:10.21105/joss.03139 <https://doi.org/10.21105/joss.03139>.\n  - L√ºdecke D, Ben-Shachar M, Patil I, Wiernik B, Bacher E, Th√©riault R, Makowski\nD (2022). \"easystats: Framework for Easy Statistical Modeling, Visualization,\nand Reporting.\" _CRAN_. doi:10.32614/CRAN.package.easystats\n<https://doi.org/10.32614/CRAN.package.easystats>, R package,\n<https://easystats.github.io/easystats/>.\n  - L√ºdecke D, Patil I, Ben-Shachar M, Wiernik B, Waggoner P, Makowski D (2021).\n\"see: An R Package for Visualizing Statistical Models.\" _Journal of Open Source\nSoftware_, *6*(64), 3393. doi:10.21105/joss.03393\n<https://doi.org/10.21105/joss.03393>.\n  - L√ºdecke D, Waggoner P, Makowski D (2019). \"insight: A Unified Interface to\nAccess Information from Model Objects in R.\" _Journal of Open Source Software_,\n*4*(38), 1412. doi:10.21105/joss.01412 <https://doi.org/10.21105/joss.01412>.\n  - Makowski D, Ben-Shachar M, L√ºdecke D (2019). \"bayestestR: Describing Effects\nand their Uncertainty, Existence and Significance within the Bayesian\nFramework.\" _Journal of Open Source Software_, *4*(40), 1541.\ndoi:10.21105/joss.01541 <https://doi.org/10.21105/joss.01541>,\n<https://joss.theoj.org/papers/10.21105/joss.01541>.\n  - Makowski D, Ben-Shachar M, Wiernik B, Patil I, Th√©riault R, L√ºdecke D (2025).\n\"modelbased: An R package to make the most out of your statistical models\nthrough marginal means, marginal effects, and model predictions.\" _Journal of\nOpen Source Software_, *10*(109), 7969. doi:10.21105/joss.07969\n<https://doi.org/10.21105/joss.07969>,\n<https://joss.theoj.org/papers/10.21105/joss.07969>.\n  - Makowski D, L√ºdecke D, Patil I, Th√©riault R, Ben-Shachar M, Wiernik B (2023).\n\"Automated Results Reporting as a Practical Tool to Improve Reproducibility and\nMethodological Best Practices Adoption.\" _CRAN_.\ndoi:10.32614/CRAN.package.report\n<https://doi.org/10.32614/CRAN.package.report>,\n<https://easystats.github.io/report/>.\n  - Makowski D, Wiernik B, Patil I, L√ºdecke D, Ben-Shachar M (2022).\n\"correlation: Methods for Correlation Analysis.\" Version 0.8.3,\n<https://CRAN.R-project.org/package=correlation>. Makowski D, Ben-Shachar M,\nPatil I, L√ºdecke D (2020). \"Methods and Algorithms for Correlation Analysis in\nR.\" _Journal of Open Source Software_, *5*(51), 2306. doi:10.21105/joss.02306\n<https://doi.org/10.21105/joss.02306>,\n<https://joss.theoj.org/papers/10.21105/joss.02306>.\n  - Patil I, Makowski D, Ben-Shachar M, Wiernik B, Bacher E, L√ºdecke D (2022).\n\"datawizard: An R Package for Easy Data Preparation and Statistical\nTransformations.\" _Journal of Open Source Software_, *7*(78), 4684.\ndoi:10.21105/joss.04684 <https://doi.org/10.21105/joss.04684>.\n  - Pinheiro J, Bates D, R Core Team (2024). _nlme: Linear and Nonlinear Mixed\nEffects Models_. R package version 3.1-166,\n<https://CRAN.R-project.org/package=nlme>. Pinheiro JC, Bates DM (2000).\n_Mixed-Effects Models in S and S-PLUS_. Springer, New York. doi:10.1007/b98882\n<https://doi.org/10.1007/b98882>.\n  - R Core Team (2024). _foreign: Read Data Stored by 'Minitab', 'S', 'SAS',\n'SPSS', 'Stata', 'Systat', 'Weka', 'dBase', ..._. R package version 0.8-87,\n<https://CRAN.R-project.org/package=foreign>.\n  - R Core Team (2024). _R: A Language and Environment for Statistical\nComputing_. R Foundation for Statistical Computing, Vienna, Austria.\n<https://www.R-project.org/>.\n  - Wickham H (2016). _ggplot2: Elegant Graphics for Data Analysis_.\nSpringer-Verlag New York. ISBN 978-3-319-24277-4,\n<https://ggplot2.tidyverse.org>.\n  - Wickham H (2023). _forcats: Tools for Working with Categorical Variables\n(Factors)_. R package version 1.0.0,\n<https://CRAN.R-project.org/package=forcats>.\n  - Wickham H, Fran√ßois R, Henry L, M√ºller K, Vaughan D (2023). _dplyr: A Grammar\nof Data Manipulation_. R package version 1.1.4,\n<https://CRAN.R-project.org/package=dplyr>.\n  - Wickham H, Vaughan D, Girlich M (2024). _tidyr: Tidy Messy Data_. R package\nversion 1.3.1, <https://CRAN.R-project.org/package=tidyr>.\n  - Yanagida T (2025). _misty: Miscellaneous Functions 'T. Yanagida'_. R package\nversion 0.7.6, <https://CRAN.R-project.org/package=misty>.\n  - Zhu H (2024). _kableExtra: Construct Complex Table with 'kable' and Pipe\nSyntax_. R package version 1.4.0,\n<https://CRAN.R-project.org/package=kableExtra>.\n```\n\n\n:::\n:::",
    "supporting": [
      "lista_4_files\\figure-html"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}