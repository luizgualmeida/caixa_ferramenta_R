# Lista 5: Modelos Lineares Generalizados (GzLM) {.unnumbered}

::: {.callout-note appearance="simple" icon=false}
## Objetivo da Lista

Explore **Generalized Linear Models (GzLM)** para variÃ¡veis resposta nÃ£o-normais: **regressÃ£o logÃ­stica** (binÃ¡ria) e **regressÃ£o de Poisson** (contagem). Aprenda a interpretar Odds Ratios e RazÃµes de PrevalÃªncia.
:::

---

## ğŸ“¦ Pacotes NecessÃ¡rios

```{r}
#| echo: true
#| message: false
#| warning: false

pacotes <- c(
  "emmeans", "tidyverse", "lme4", "nlme", "flexplot",
  "foreign", "dplyr", "multcomp", "effects", "sjstats",
  "sjPlot", "ggplot2", "forcats", "performance",
  "easystats", "kableExtra", "fitdistrplus", "AER",
  "gtsummary", "broom"
)

pacotes_faltantes <- pacotes[!pacotes %in% installed.packages()[, "Package"]]
if (length(pacotes_faltantes) > 0) {
  install.packages(pacotes_faltantes, dependencies = TRUE)
}

invisible(lapply(pacotes, library, character.only = TRUE))
cat("âœ“ Pacotes carregados!\n")
```

---

## ğŸ“¥ PreparaÃ§Ã£o dos Dados

::: {.callout-important}
## Download NecessÃ¡rio

Baixe o banco **"[Dados Amostra](https://drive.google.com/file/d/XXXXX)"** e salve na pasta do projeto.
:::

```{r}
#| echo: true
#| message: false
#| warning: false

# Carregar dados originais
original <- read.spss("Dados Amostra.sav", to.data.frame = TRUE)

# Criar cÃ³pia de trabalho (boa prÃ¡tica!)
db <- original
```

---

### CorreÃ§Ã£o de Tipos

```{r}
#| echo: true

# Verificar estrutura
glimpse(db)

# Converter variÃ¡veis numÃ©ricas
db$childs <- as.integer(db$childs)
db$age <- as.numeric(db$age)
db$educ <- as.numeric(db$educ)
db$tvhours <- as.numeric(db$tvhours)

# Confirmar mudanÃ§as
glimpse(db)
```

::: {.callout-tip}
## ğŸ’¡ Boa PrÃ¡tica

Mantenha sempre uma cÃ³pia do banco original! Facilita comparaÃ§Ãµes e evita perda de dados.
:::

---

### Verificar Representatividade

```{r}
#| echo: true

# Tabelas de contingÃªncia
xtabs(~ attsprts + sex, data = db)
xtabs(~ attsprts + life, data = db)
xtabs(~ attsprts + aderencia, data = db)
```

::: {.callout-note}
Verifique se hÃ¡ cÃ©lulas vazias ou com poucos casos. Isso pode afetar a estabilidade dos modelos.
:::

---

## ğŸ¯ Parte A: RegressÃ£o LogÃ­stica

::: {.callout-tip}
## Quando Usar?

**RegressÃ£o LogÃ­stica** Ã© adequada para:
- **VD binÃ¡ria:** Sim/NÃ£o, Sucesso/Fracasso
- Modelar probabilidade de pertencer a uma categoria
- Estimar **Odds Ratios** (razÃ£o de chances)

**Exemplo:** Praticar esportes (Sim vs NÃ£o)
:::

---

### Pergunta de Pesquisa

::: {.callout-note}
## ExercÃ­cio A

Qual o efeito de **sexo, opiniÃ£o sobre vida, nÃºmero de filhos, idade, escolaridade e horas de TV** sobre a **prÃ¡tica de esportes**?
:::

---

### PreparaÃ§Ã£o: NÃ­veis de ReferÃªncia

```{r}
#| echo: true

# Verificar nÃ­veis atuais
cat("NÃ­veis originais:\n")
print(levels(db$attsprts))
print(levels(db$sex))
print(levels(db$life))

# Ajustar referÃªncia para "No" (nÃ£o pratica)
db$attsprts <- relevel(db$attsprts, ref = "No")

cat("\nNovo nÃ­vel de referÃªncia:\n")
print(levels(db$attsprts))
```

::: {.callout-important}
## Por que isso importa?

Com "No" como referÃªncia, OR > 1 indica **maior chance de praticar esportes**.
:::

---

### Ajuste do Modelo

```{r}
#| echo: true

modelo_logistico <- glm(
  attsprts ~ sex + life + childs + educ + tvhours + age,
  data = db,
  family = "binomial"
)
```

::: {.callout-note collapse="true"}
## ğŸ” Anatomia do Modelo LogÃ­stico

**FunÃ§Ã£o:** `glm()` (Generalized Linear Model)

**Family:** `binomial` com link logit (padrÃ£o)
$$
\log\left(\frac{p}{1-p}\right) = \beta_0 + \beta_1 X_1 + \beta_2 X_2 + \ldots
$$

**InterpretaÃ§Ã£o:**
- Coeficientes: mudanÃ§a no log-odds
- exp(coeficiente): Odds Ratio (OR)
:::

---

### Resultados: SaÃ­da BÃ¡sica

```{r}
#| echo: true

summary(modelo_logistico)
```

::: {.callout-warning}
Coeficientes estÃ£o em **log-odds**. Precisamos exponenciar para obter ORs interpretÃ¡veis!
:::

---

### Resultados: Tabela Formatada

```{r}
#| echo: true

tab_model(
  modelo_logistico,
  show.se = TRUE,
  show.aic = TRUE,
  show.loglik = TRUE,
  show.ci = TRUE,
  transform = "exp",
  title = "RegressÃ£o LogÃ­stica: PrÃ¡tica de Esportes"
)
```

::: {.callout-tip}
## ğŸ“Š Interpretando Odds Ratios

**OR = 1:** Nenhum efeito  
**OR > 1:** Aumenta chance de praticar esportes  
**OR < 1:** Diminui chance de praticar esportes

**Exemplo:** OR = 1.50 â†’ 50% mais chance
:::

---

### Resultados: FunÃ§Ã£o `summary()`

```{r}
#| echo: true

summary(modelo_logistico)
```

::: {.callout-note collapse="true"}
## ğŸ” Interpretando a Tabela

**Colunas importantes:**
- **OR:** Odds Ratio direta
- **inverse.OR:** OR com referÃªncia invertida
- **p.value:** SignificÃ¢ncia estatÃ­stica

**Uso do inverse.OR:**
Quando OR < 1, use inverse.OR para facilitar interpretaÃ§Ã£o.

**Exemplo com sexo:**
- OR = 0.636 (Female vs Male)
- inverse.OR = 1.57 (Male vs Female)

**InterpretaÃ§Ã£o (usando inverse.OR):**
"Mulheres tÃªm 1.57Ã— mais chance de praticar esportes que homens"
:::

---

### Mudando ReferÃªncia: DemonstraÃ§Ã£o

```{r}
#| echo: true

# Mudar referÃªncia de sexo
db$sex <- relevel(db$sex, ref = "Female")

# Re-ajustar modelo
modelo_logistico_v2 <- glm(
  attsprts ~ sex + life + childs + educ + tvhours + age,
  data = db,
  family = "binomial"
)
summary(modelo_logistico_v2)
```

::: {.callout-note}
Note que OR do Modelo 2 = inverse.OR do Modelo 1! A escolha da referÃªncia afeta apenas a **direÃ§Ã£o** da comparaÃ§Ã£o, nÃ£o o resultado estatÃ­stico.
:::

---

## ğŸ¯ Parte D: RegressÃ£o de Poisson

::: {.callout-tip}
## Quando Usar?

**RegressÃ£o de Poisson** Ã© adequada para:
- **VD de contagem:** 0, 1, 2, 3, ...
- Eventos raros
- Estimar **RazÃµes de PrevalÃªncia** (RP) ou Taxas

**Exemplo:** NÃºmero de filhos
:::

---

### Pergunta de Pesquisa

::: {.callout-note}
## ExercÃ­cio D

Qual o efeito de **sexo, opiniÃ£o sobre vida e prÃ¡tica de esportes** sobre **nÃºmero de filhos**, controlando por **idade e escolaridade**?
:::

---

### Modelo 1: GLM Normal (Baseline)

```{r}
#| echo: true

modelo_glm_normal <- glm(
  childs ~ sex + life + attsprts + age + educ,
  data = db,
  family = "gaussian"  # Assume normalidade
)

summary(modelo_glm_normal)
```

---

### Modelo 2: GLM Poisson

```{r}
#| echo: true

modelo_poisson <- glm(
  childs ~ sex + life + attsprts + age + educ,
  data = db,
  family = "poisson"
)

summary(modelo_poisson)
```

---

### ComparaÃ§Ã£o de Modelos

```{r}
#| echo: true

# CritÃ©rios de informaÃ§Ã£o
criterios <- data.frame(
  Modelo = c("Normal", "Poisson"),
  AIC = c(AIC(modelo_glm_normal), AIC(modelo_poisson)),
  BIC = c(BIC(modelo_glm_normal), BIC(modelo_poisson))
)

criterios$AIC <- round(criterios$AIC, 2)
criterios$BIC <- round(criterios$BIC, 2)

# Marcar melhor
criterios$AIC <- ifelse(
  criterios$AIC == min(criterios$AIC),
  paste0(criterios$AIC, " â˜…"),
  criterios$AIC
)

criterios$BIC <- ifelse(
  criterios$BIC == min(criterios$BIC),
  paste0(criterios$BIC, " â˜…"),
  criterios$BIC
)

knitr::kable(criterios, caption = "ComparaÃ§Ã£o: Normal vs Poisson")
```

::: {.callout-note}
## ğŸ“Š Resultado

Modelo Poisson apresenta **melhor ajuste** (menor AIC/BIC).
:::

---

### InterpretaÃ§Ã£o: RazÃµes de PrevalÃªncia

```{r}
#| echo: true

# Usando estimates()
est_poisson <- summary(modelo_poisson)
print(est_poisson)
```

::: {.callout-tip}
## ğŸ“Š Interpretando RazÃµes de PrevalÃªncia

**multiplicative.coef** = exp(Î²) = RazÃ£o de PrevalÃªncia (RP)

**RP = 1:** Nenhum efeito  
**RP > 1:** Aumenta contagem esperada  
**RP < 1:** Diminui contagem esperada

**Exemplo:**
- RP = 1.10 â†’ 10% mais filhos esperados
- RP = 0.97 â†’ 3% menos filhos esperados
:::

---

### Exemplo de InterpretaÃ§Ã£o

```{r}
#| echo: true

# Extrair coeficientes exponenciados
rp_table <- data.frame(
  Variavel = names(coef(modelo_poisson)),
  RP = round(exp(coef(modelo_poisson)), 3),
  RP_Inversa = round(exp(-coef(modelo_poisson)), 3)
)

knitr::kable(
  rp_table[c("attsprtsYes", "educ"), ],
  caption = "RazÃµes de PrevalÃªncia Selecionadas"
)
```

**InterpretaÃ§Ãµes:**

**PrÃ¡tica de Esportes (attsprtsYes):**
"Pessoas que praticam esportes tÃªm 10% mais chance de ter um filho adicional comparado a sedentÃ¡rios"

**EducaÃ§Ã£o (educ):**
"Para cada ano adicional de educaÃ§Ã£o, a chance de ter um filho diminui ~3%"

---

## ğŸ”§ DiagnÃ³sticos e Pressupostos

### SobredispersÃ£o em Poisson

::: {.callout-warning}
## âš ï¸ SobredispersÃ£o

**Problema:** VariÃ¢ncia > MÃ©dia (viola pressuposto de Poisson)

**ConsequÃªncia:** Erros-padrÃ£o subestimados, p-valores muito otimistas

**SoluÃ§Ã£o:** Usar **Binomial Negativa** ou correÃ§Ã£o quasi-Poisson
:::

```{r}
#| echo: true
#| message: false
#| warning: false

# Teste formal de sobredispersÃ£o
dispersiontest(modelo_poisson, trafo = 1)
```

::: {.callout-note}
## InterpretaÃ§Ã£o

**Hâ‚€:** NÃ£o hÃ¡ sobredispersÃ£o  
**p < 0.05:** SobredispersÃ£o detectada â†’ Considerar Binomial Negativa
:::

---

### GrÃ¡ficos DiagnÃ³sticos

```{r}
#| echo: true
#| fig-width: 12
#| fig-height: 10

par(mfrow = c(2, 3))
plot(modelo_poisson, which = 1:6)
par(mfrow = c(1, 1))
```

---

## ğŸ”§ Extras AvanÃ§ados

### Pseudo RÂ²

::: {.callout-tip}
## O que Ã© Pseudo RÂ²?

AnÃ¡logo ao RÂ² para modelos logÃ­sticos/Poisson. Indica "proporÃ§Ã£o de verossimilhanÃ§a explicada".

**MÃ©todos comuns:**
- **Hosmer-Lemeshow:** Baseado em deviance
- **Cox-Snell:** Ajustado pelo tamanho amostral
- **Nagelkerke:** Normalizado para variar 0-1
:::

```{r}
#| echo: true

# FunÃ§Ã£o personalizada
logisticPseudoR2s <- function(LogModel) {
  dev <- LogModel$deviance
  nullDev <- LogModel$null.deviance
  modelN <- length(LogModel$fitted.values)
  
  R.l <- 1 - dev / nullDev
  R.cs <- 1 - exp(-(nullDev - dev) / modelN)
  R.n <- R.cs / (1 - (exp(-(nullDev / modelN))))
  
  data.frame(
    Metodo = c("Hosmer-Lemeshow", "Cox-Snell", "Nagelkerke"),
    Pseudo_R2 = c(round(R.l, 3), round(R.cs, 3), round(R.n, 3))
  )
}

# Aplicar ao modelo logÃ­stico
logisticPseudoR2s(modelo_logistico)
```

---

### CorreÃ§Ã£o de Bonferroni

::: {.callout-tip collapse="true"}
## Quando Usar CorreÃ§Ãµes?

**Problema:** MÃºltiplas comparaÃ§Ãµes inflam erro Tipo I

**CorreÃ§Ãµes disponÃ­veis:**
- **Bonferroni:** Mais conservadora (divide Î± por nÂº de testes)
- **Holm:** Menos conservadora, sequencial
- **Hochberg:** Similar a Holm
- **FDR (Benjamini-Hochberg):** Controla taxa de falsas descobertas

**Trade-off:** ProteÃ§Ã£o contra falsos positivos â†” Poder estatÃ­stico
:::

```{r}
#| echo: true

tab_model(
  modelo_logistico,
  show.se = TRUE,
  show.ci = TRUE,
  transform = "exp",
  p.adjust = "bonferroni",
  title = "RegressÃ£o LogÃ­stica com CorreÃ§Ã£o de Bonferroni"
)
```

---

### Tabela de Resultados Completa

```{r}
#| echo: true

# Extrair tudo em uma tabela
resultados_completos <- tidy(
  modelo_logistico,
  exponentiate = TRUE,
  conf.int = TRUE
)

knitr::kable(
  resultados_completos,
  digits = 3,
  caption = "Resultados Completos: RegressÃ£o LogÃ­stica"
)
```

---

### Modelo com InteraÃ§Ãµes

```{r}
#| echo: true

modelo_interacao <- glm(
  childs ~ sex * life * attsprts + age + educ,
  data = db,
  family = "poisson"
)

# Tabela formatada
tab_model(
  modelo_interacao,
  show.se = TRUE,
  show.ci = TRUE,
  title = "Modelo Poisson com InteraÃ§Ãµes"
)
```

::: {.callout-tip}
## ğŸ’¡ Pratique!

Crie modelos com diferentes interaÃ§Ãµes e compare AICs. Qual combinaÃ§Ã£o explica melhor os dados?
:::

---

## ğŸ“š Material Complementar

### Aula em VÃ­deo (SPSS)

{{< video https://www.youtube.com/watch?v=IHhhsXYZ-1A title='GLzM - Generalized Linear Model - Aula PrÃ¡tica #5 (SPSS)' >}}

---

### Recursos Adicionais

::: {.callout-note collapse="true"}
## ğŸ“– Leituras Recomendadas

**RegressÃ£o LogÃ­stica:**
- Hosmer & Lemeshow (2013). *Applied Logistic Regression*
- [UCLA Stats Guide - Logistic Regression](https://stats.oarc.ucla.edu/r/dae/logit-regression/)

**RegressÃ£o de Poisson:**
- [Bookdown: Poisson Regression](https://bookdown.org/drki_musa/dataanalysis/poisson-regression.html)
- Agresti (2015). *Foundations of Linear and Generalized Linear Models*

**VÃ­deos:**
- [StatQuest: Logistic Regression](https://www.youtube.com/watch?v=QPY4zuxs1W0)
:::

---

### DecisÃ£o: Poisson vs Binomial Negativa

::: {.callout-tip}
## Guia RÃ¡pido

| SituaÃ§Ã£o | Modelo Recomendado |
|----------|-------------------|
| VariÃ¢ncia â‰ˆ MÃ©dia | Poisson |
| VariÃ¢ncia >> MÃ©dia | Binomial Negativa |
| Muitos zeros | Zero-Inflated Poisson/NB |
| Eventos raros | Poisson |

**Testar sobredispersÃ£o:** Use `dispersiontest()` ou compare AIC de Poisson vs NB
:::

---

## ğŸ”§ InformaÃ§Ãµes de SessÃ£o

```{r}
#| echo: true
report(sessionInfo())
```

---

::: {.callout-note appearance="simple"}
## ğŸ“ Resumo da Lista 5

Nesta lista vocÃª:

âœ… Dominou **regressÃ£o logÃ­stica** para variÃ¡veis binÃ¡rias  
âœ… Aprendeu a interpretar **Odds Ratios**  
âœ… Explorou **regressÃ£o de Poisson** para contagens  
âœ… Calculou e interpretou **RazÃµes de PrevalÃªncia**  
âœ… Comparou modelos via **AIC/BIC**  
âœ… Testou **sobredispersÃ£o** em Poisson  
âœ… Aplicou **correÃ§Ãµes para comparaÃ§Ãµes mÃºltiplas**  

**Conceitos-chave:**
- GzLM estende GLM para distribuiÃ§Ãµes nÃ£o-normais
- LogÃ­stica: OR interpreta mudanÃ§as em chances
- Poisson: RP interpreta mudanÃ§as em contagens
- SobredispersÃ£o: problema comum que requer atenÃ§Ã£o

**PrÃ³ximos passos:**
- Explore interaÃ§Ãµes complexas
- Teste modelos Zero-Inflated para excesso de zeros
- Pratique interpretaÃ§Ã£o de ORs e RPs
- Compare com Binomial Negativa quando apropriado
:::