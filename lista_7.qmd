# Lista 7: S√©ries Temporais (ARIMA) {.unnumbered}

::: {.callout-note appearance="simple" icon=false}
## Objetivo da Lista

Domine **modelos ARIMA** para an√°lise de s√©ries temporais: avaliar estacionaridade, identificar padr√µes sazonais e fazer previs√µes futuras. Trabalharemos com dados de consumo de cigarros e sal√°rios ao longo do tempo.
:::

---

## üì¶ Pacotes

```{r}
#| echo: false
#| message: false
#| warning: false

pacotes <- c(
  "tidyverse", "foreign", "ggplot2", "kableExtra",
  "forecast", "tseries", "lmtest", "prophet", "report"
)

pacotes_faltantes <- pacotes[!pacotes %in% installed.packages()[, "Package"]]
if (length(pacotes_faltantes) > 0) {
  install.packages(pacotes_faltantes, dependencies = TRUE)
}

invisible(lapply(pacotes, library, character.only = TRUE))
cat("‚úì Pacotes de s√©ries temporais carregados!\n")
```

---

## üîç O que √© ARIMA?

::: {.callout-tip}
## ARIMA = AutoRegressive Integrated Moving Average

Modelo para s√©ries temporais que combina tr√™s componentes:

**AR (p)** - AutoRegressivo
- Usa valores **passados** da s√©rie
- "O hoje depende do ontem"
- p = n√∫mero de defasagens (lags)

**I (d)** - Integrado
- N√∫mero de **diferen√ßas** para tornar s√©rie estacion√°ria
- d = 0 (estacion√°ria), d = 1 (1¬™ diferen√ßa), etc.

**MA (q)** - M√©dia M√≥vel
- Usa **erros passados** da s√©rie
- "Corre√ß√µes baseadas em erros anteriores"
- q = n√∫mero de termos de erro

**Nota√ß√£o:** ARIMA(p, d, q)
:::

---

## üßπ Prepara√ß√£o do Ambiente

```{r}
#| echo: true

# Limpar ambiente
rm(list = ls(all.names = TRUE))
gc()

# Configura√ß√µes
options(scipen = 999, stringsAsFactors = FALSE)
set.seed(42)
```

---

## üì• Parte 1: Estacionaridade (Dados de Cigarros)

::: {.callout-important}
## Conceito Fundamental: Estacionaridade

Uma s√©rie √© **estacion√°ria** quando:
- **M√©dia constante** ao longo do tempo
- **Vari√¢ncia constante**
- **Autocorrela√ß√£o** depende apenas da defasagem, n√£o do tempo

**Por que importa?** Modelos ARIMA requerem estacionaridade!
:::

---

### Carregar Dados

```{r}
#| echo: true
#| message: false
#| warning: false

db_cigarro <- read.spss("CigarrosROD_1.sav", to.data.frame = TRUE)
glimpse(db_cigarro)
```

---

### Inspe√ß√£o Visual

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 5

# M√©dia da s√©rie
media_cigarros <- mean(db_cigarro$cigarrosROD)

# Plot simples
plot.ts(db_cigarro$cigarrosROD, 
        main = "Consumo de Cigarros ao Longo do Tempo",
        ylab = "Cigarros por Dia", xlab = "Tempo")
abline(h = media_cigarros, col = "blue", lty = 2, lwd = 2)
legend("topright", legend = "M√©dia", col = "blue", lty = 2, lwd = 2)
```

::: {.callout-warning}
## üìä Diagn√≥stico Visual

Valores **desviam bastante da m√©dia** ‚Üí S√©rie **N√ÉO √© estacion√°ria**

Observe tend√™ncia de queda ao longo do tempo.
:::

---

### Teste Augmented Dickey-Fuller (ADF)

::: {.callout-tip}
## Teste ADF

**H‚ÇÄ:** S√©rie √© **n√£o-estacion√°ria** (possui raiz unit√°ria)  
**H‚ÇÅ:** S√©rie √© **estacion√°ria**

**Decis√£o:**
- p < 0.05 ‚Üí Rejeita H‚ÇÄ ‚Üí Estacion√°ria ‚úì
- p > 0.05 ‚Üí N√£o rejeita H‚ÇÄ ‚Üí N√£o-estacion√°ria ‚úó
:::

```{r}
#| echo: true

adf.test(db_cigarro$cigarrosROD)
```

::: {.callout-note}
## Resultado

**p > 0.05** ‚Üí S√©rie **n√£o √© estacion√°ria**

Precisamos transform√°-la!
:::

---

### Fun√ß√£o de Autocorrela√ß√£o (ACF)

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 6

# An√°lise completa
ggtsdisplay(db_cigarro$cigarrosROD, 
            main = "Diagn√≥stico da S√©rie Original")
```

::: {.callout-tip collapse="true"}
## üîç Interpretando ACF

**Barras acima da linha tracejada** = Autocorrela√ß√£o significativa

**Padr√£o decrescente lento** = Tend√™ncia (n√£o-estacion√°ria)

**Lags candidatos:** Onde ACF cruza o limiar pela primeira vez
:::

---

### Teste de Ljung-Box

```{r}
#| echo: true

# Calcular ACF
acf_valores <- acf(db_cigarro$cigarrosROD, plot = FALSE)

# Testar m√∫ltiplos lags
max_lags <- min(20, length(acf_valores$acf) - 1)
resultados <- data.frame(
  Lag = 1:max_lags,
  P_Value = sapply(1:max_lags, function(lag) {
    Box.test(acf_valores$acf, lag = lag, type = "Ljung-Box")$p.value
  })
)

# Destacar significativos
resultados$Sig <- ifelse(resultados$P_Value < 0.05, "‚úì", "")

kable(head(resultados, 10), digits = 4,
      caption = "Teste de Ljung-Box por Lag")
```

---

### Transforma√ß√£o: Diferencia√ß√£o

```{r}
#| echo: true

# Determinar n√∫mero √≥timo de diferen√ßas
n_diffs <- ndiffs(db_cigarro$cigarrosROD)
cat("Diferen√ßas necess√°rias:", n_diffs, "\n")

# Aplicar diferencia√ß√£o
serie_diff <- diff(db_cigarro$cigarrosROD, differences = n_diffs)

# Verificar estacionaridade
adf.test(serie_diff)
```

---

### Visualiza√ß√£o P√≥s-Transforma√ß√£o

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 5

# Plot da s√©rie diferenciada
media_diff <- mean(serie_diff)
plot.ts(serie_diff,
        main = "S√©rie Ap√≥s Diferencia√ß√£o",
        ylab = "Diferen√ßa", xlab = "Tempo")
abline(h = media_diff, col = "red", lty = 2, lwd = 2)
abline(h = 0, col = "gray", lty = 3)
```

::: {.callout-tip}
## ‚úì S√©rie Agora Estacion√°ria!

- Oscila em torno da m√©dia (linha vermelha)
- Vari√¢ncia constante
- ADF test significativo (p < 0.05)
:::

---

## üìä Parte 2: Modelagem ARIMA (Dados de Sal√°rios)

### Carregar Dados

```{r}
#| echo: true
#| message: false
#| warning: false

db_salarios <- read.spss("dados series temporais.sav", 
                         to.data.frame = TRUE)
glimpse(db_salarios)
```

---

### Criar Objeto de S√©rie Temporal

```{r}
#| echo: true

# Sal√°rios masculinos como s√©rie temporal
ts_men <- ts(db_salarios$men,
             frequency = 12,      # Mensal
             start = c(1989, 1))  # Janeiro de 1989

# Visualiza√ß√£o
plot(ts_men, main = "Sal√°rios Masculinos (1989-)",
     ylab = "Sal√°rio", xlab = "Tempo")
```

---

### Plot Sazonal

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 6

seasonplot(ts_men,
           col = rainbow(12),
           year.labels = TRUE,
           type = "o", pch = 16,
           main = "Padr√£o Sazonal de Sal√°rios")
```

---

### Diagn√≥stico da S√©rie

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 8

ggtsdisplay(ts_men, main = "Diagn√≥stico: Sal√°rios Masculinos")
```

---

## üéØ Ajustando Modelos ARIMA

### Modelo 1: ARIMA(1,0,0)

```{r}
#| echo: true

modelo_100 <- Arima(db_salarios$men, order = c(1, 0, 0))
summary(modelo_100)
```

---

### Modelo 2: ARIMA(0,1,0)

```{r}
#| echo: true

modelo_010 <- Arima(db_salarios$men, order = c(0, 1, 0))
summary(modelo_010)
```

---

### Modelo 3: Auto ARIMA

::: {.callout-tip}
## `auto.arima()` 

Fun√ß√£o que **automaticamente** seleciona os melhores par√¢metros (p, d, q) minimizando AIC/BIC.
:::

```{r}
#| echo: true

# Encontrar melhor modelo
auto.arima(db_salarios$men, trace = TRUE)
```

```{r}
#| echo: true

# Ajustar modelo sugerido
modelo_auto <- auto.arima(db_salarios$men)
summary(modelo_auto)
```

---

### Compara√ß√£o de Modelos

```{r}
#| echo: true

modelos_comp <- data.frame(
  Modelo = c("ARIMA(1,0,0)", "ARIMA(0,1,0)", "Auto"),
  AIC = c(AIC(modelo_100), AIC(modelo_010), AIC(modelo_auto)),
  BIC = c(BIC(modelo_100), BIC(modelo_010), BIC(modelo_auto))
)

modelos_comp <- modelos_comp %>%
  mutate(
    AIC = round(AIC, 2),
    BIC = round(BIC, 2),
    Melhor_AIC = ifelse(AIC == min(AIC), "‚òÖ", ""),
    Melhor_BIC = ifelse(BIC == min(BIC), "‚òÖ", "")
  )

kable(modelos_comp, caption = "Compara√ß√£o de Modelos (‚òÖ = melhor)")
```

---

### Visualiza√ß√£o: Ajustado vs Real

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 6

# Dataframe para plot
df_plot <- data.frame(
  Tempo = seq_along(modelo_auto$fitted),
  Ajustado = as.numeric(modelo_auto$fitted),
  Real = as.numeric(modelo_auto$x)
)

# Gr√°fico
ggplot(df_plot, aes(x = Tempo)) +
  geom_line(aes(y = Real, color = "Real"), linewidth = 1) +
  geom_line(aes(y = Ajustado, color = "Ajustado"), linewidth = 1) +
  labs(
    title = "Modelo ARIMA: Valores Ajustados vs Reais",
    x = "Tempo",
    y = "Sal√°rio",
    color = "S√©rie"
  ) +
  scale_color_manual(values = c("Real" = "blue", "Ajustado" = "red")) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

---

## üîß Modelo com Covari√°veis

```{r}
#| echo: true

# Matriz de covari√°veis
covars <- as.matrix(db_salarios[, c("horas", "divida", "idade", 
                                     "propaganda", "escolaridade")])

# Auto ARIMA com covari√°veis
modelo_com_covars <- auto.arima(db_salarios$men, xreg = covars)
summary(modelo_com_covars)
```

---

### Coeficientes e Signific√¢ncia

```{r}
#| echo: true

# Teste de coeficientes
test_coef <- coeftest(modelo_com_covars)

# Formatar resultados
resultados <- data.frame(
  Variavel = rownames(test_coef),
  Coeficiente = round(test_coef[, "Estimate"], 3),
  EP = round(test_coef[, "Std. Error"], 3),
  z = round(test_coef[, "z value"], 2),
  p = round(test_coef[, "Pr(>|z|)"], 4)
) %>%
  mutate(Sig = case_when(
    p < 0.001 ~ "***",
    p < 0.01 ~ "**",
    p < 0.05 ~ "*",
    TRUE ~ ""
  ))

kable(resultados, caption = "Coeficientes do Modelo com Covari√°veis")
```

---

## üîÆ Previs√µes (Forecasting)

### Sal√°rios Masculinos: 50 Meses √† Frente

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 6

# Ajustar modelo
fit_men <- auto.arima(ts_men)

# Prever 50 meses
fcast_men <- forecast(fit_men, h = 50)

# Visualizar
autoplot(fcast_men) +
  labs(
    title = "Previs√£o de Sal√°rios Masculinos (50 meses)",
    x = "Tempo",
    y = "Sal√°rio"
  ) +
  theme_minimal()
```

---

### Sal√°rios Femininos: Compara√ß√£o

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 6

# S√©rie temporal feminina
ts_women <- ts(db_salarios$women,
               frequency = 12,
               start = c(1989, 1))

# Modelo e previs√£o
fit_women <- auto.arima(ts_women)
fcast_women <- forecast(fit_women, h = 50)

# Visualizar
autoplot(fcast_women) +
  labs(
    title = "Previs√£o de Sal√°rios Femininos (50 meses)",
    x = "Tempo",
    y = "Sal√°rio"
  ) +
  theme_minimal()
```

---

## ‚úÖ Diagn√≥stico de Res√≠duos

::: {.callout-important}
## Por que Verificar Res√≠duos?

Res√≠duos devem ser **ru√≠do branco**:
- M√©dia zero
- Vari√¢ncia constante
- Sem autocorrela√ß√£o
- Normalmente distribu√≠dos

Se res√≠duos t√™m padr√£o ‚Üí Modelo n√£o capturou toda a informa√ß√£o!
:::

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 8

checkresiduals(modelo_auto)
```

::: {.callout-note collapse="true"}
## üîç Interpretando Diagn√≥sticos

**Gr√°fico 1 (Res√≠duos ao longo do tempo):**
- Deve oscilar aleatoriamente em torno de zero
- Sem padr√µes ou tend√™ncias

**Gr√°fico 2 (ACF dos res√≠duos):**
- Nenhuma barra significativa (exceto lag 0)
- Indica aus√™ncia de autocorrela√ß√£o restante

**Gr√°fico 3 (Histograma):**
- Aproximadamente normal
- Centrado em zero

**Teste de Ljung-Box:**
- p > 0.05 ‚Üí Res√≠duos s√£o ru√≠do branco ‚úì
:::

---

## üìö Material Complementar

{{< video https://www.youtube.com/watch?v=qTQ1YDgyByE title='S√©ries Temporais (ARIMA) - Aula Pr√°tica #7' >}}

---

### Recursos Adicionais

::: {.callout-note collapse="true"}
## üìñ Leituras e V√≠deos Recomendados

**Livros:**
- Hyndman & Athanasopoulos. *Forecasting: Principles and Practice*

**Tutoriais Online:**
- [Prophet (Facebook)](https://facebook.github.io/prophet/docs/installation.html#r)
- [RPubs - Time Series with Prophet](https://rpubs.com/mpleo/timeseries_prophet)

**V√≠deos em Portugu√™s:**
- [ARIMA em R - Tutorial Completo](https://www.youtube.com/watch?v=Txuo9JQjnKE)
- [Playlist S√©ries Temporais](https://www.youtube.com/watch?v=RJzmHkGWCxs&list=PLEuzmtv9IuT_vg5oE0lQyZR-wgbVeGztt)
:::

---

## üéØ Fluxo de Trabalho ARIMA

::: {.callout-tip}
## Checklist Passo-a-Passo

1. **Visualizar** a s√©rie
2. **Testar estacionaridade** (ADF, KPSS)
3. **Transformar** se necess√°rio (diferencia√ß√£o, Box-Cox)
4. **Identificar** p, d, q (ACF, PACF, ou auto.arima)
5. **Ajustar** modelo
6. **Diagnosticar** res√≠duos
7. **Comparar** modelos (AIC, BIC)
8. **Prever** valores futuros
9. **Validar** com dados holdout
:::

---

## üîß Informa√ß√µes de Sess√£o

```{r}
report(sessionInfo())
```

---

::: {.callout-note appearance="simple"}
## üéì Resumo da Lista 7

Nesta lista voc√™:

‚úÖ Compreendeu **conceitos fundamentais** de s√©ries temporais  
‚úÖ Avaliou **estacionaridade** visualmente e com testes  
‚úÖ Aplicou **diferencia√ß√£o** para tornar s√©ries estacion√°rias  
‚úÖ Ajustou modelos **ARIMA** manualmente e com auto.arima  
‚úÖ Incluiu **covari√°veis** em modelos ARIMA  
‚úÖ Fez **previs√µes** futuras com intervalos de confian√ßa  
‚úÖ Diagnosticou **res√≠duos** para validar modelos  

**Conceitos-chave:**
- ARIMA(p,d,q): AR + Diferencia√ß√£o + MA
- Estacionaridade: pr√©-requisito para ARIMA
- ADF test: teste formal de estacionaridade
- ACF/PACF: identificar ordem do modelo
- auto.arima(): sele√ß√£o autom√°tica de modelo
- Res√≠duos: devem ser ru√≠do branco

**Pr√≥ximos passos:**
- Explorar SARIMA (sazonal)
- Modelos Prophet para padr√µes complexos
- VAR para m√∫ltiplas s√©ries interdependentes
- Machine Learning para s√©ries temporais
:::