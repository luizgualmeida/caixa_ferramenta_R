# Lista 1: GLM, GEE e GMM {.unnumbered}

::: {.callout-note appearance="simple" icon=false}
## Objetivo da Lista

Nesta primeira lista pr√°tica, voc√™ aprender√° a implementar e interpretar tr√™s abordagens fundamentais para an√°lise de medidas repetidas: **GLM**, **GEE** e **GMM**. O foco √© compreender como cada m√©todo funciona no R, com compara√ß√µes detalhadas em listas subsequentes.
:::

---

## üì• Dados e Materiais

::: {.callout-important}
## Download Necess√°rio

Fa√ßa o download do banco de dados **"[new drug respiratory&pulse](https://drive.google.com/file/d/145uyQOn_3Mk_CQxpu-pFKfm8u7DE257U/view?usp=sharing)"** e salve na pasta do seu projeto.
:::

```{r}
#| echo: false
#| message: false
#| warning: false
#| include: false

# Lista de pacotes necess√°rios
pacotes <- c(
  "emmeans", "ggplot2", "lme4", "nlme", "flexplot",
  "foreign", "tidyr", "dplyr", "multcomp", "effects",
  "sjstats", "rstatix", "geepack", "performance",
  "see", "rempsyc", "easystats"
)

# Verificar e instalar pacotes faltantes
pacotes_faltantes <- pacotes[!pacotes %in% installed.packages()[, "Package"]]
if (length(pacotes_faltantes) > 0) {
  install.packages(pacotes_faltantes, dependencies = TRUE)
}

# Carregar todos os pacotes
invisible(lapply(pacotes, library, character.only = TRUE))
```

```{r}
#| echo: false
#| warning: false
#| message: false
#| include: false

# Prepara√ß√£o dos dados (oculto - j√° feito no cap√≠tulo anterior)
original_wide <- read.spss("bd_New drug_respiratory&pulse.sav", to.data.frame = TRUE)

bd <- original_wide %>%
  rename_with(~gsub("(resp|pulse)(\\d+)", "\\1_\\2", .), -drug) %>%
  mutate(ID = row_number()) %>%
  select(ID, everything())

bd_long <- pivot_longer(bd, 
                        cols = resp_1:pulse_3, 
                        names_to = c(".value", "Tempo"), 
                        names_pattern = "(.+)_(.+)")

bd_long$Tempo <- factor(bd_long$Tempo)
bd_long$ID <- factor(bd_long$ID)
```

---

## üìä Parte 1: GLM (Modelo Linear Geral)

### Modelo para "Resp"

Vamos ajustar um modelo de medidas repetidas para a vari√°vel respirat√≥ria:

$$
\text{resp} = \beta_0 + \beta_1\text{drug} + \beta_2\text{Tempo} + \beta_3\text{drug} \times \text{Tempo} + \varepsilon
$$

```{r}
#| echo: true

modelo1_resp <- lm(resp ~ drug + Tempo + drug*Tempo, 
                   data = bd_long)

summary(modelo1_resp)
```

::: {.callout-note collapse="true"}
## üìñ Interpretando os Coeficientes

- **Intercept:** Valor m√©dio de resp no grupo refer√™ncia (placebo) no tempo 1
- **drug:** Diferen√ßa entre tratamento e placebo no tempo 1
- **Tempo:** Mudan√ßa ao longo do tempo no grupo placebo
- **drug:Tempo:** Como o efeito da droga muda ao longo do tempo (intera√ß√£o)

**Signific√¢ncia estat√≠stica** √© indicada pelos valores-p na coluna `Pr(>|t|)`.
:::

---

#### Diagn√≥stico do Modelo

::: {.panel-tabset}

##### Predi√ß√£o e Linearidade

```{r}
#| echo: true
#| message: false
#| warning: false

check_model(modelo1_resp, 
            check = c("pp_check", "linearity"))
```

**Posterior Predictive Check:**
Compara dados observados (verde) com simula√ß√µes do modelo (azul). Boa sobreposi√ß√£o indica ajuste adequado.

**Linearidade:**
Linha horizontal sugere rela√ß√£o linear apropriada. Padr√µes em U indicam necessidade de termos quadr√°ticos.

##### Homogeneidade e Outliers

```{r}
#| echo: true
#| message: false
#| warning: false

check_model(modelo1_resp, 
            check = c("homogeneity", "outliers"))
```

**Homogeneidade:**
Pontos devem se distribuir uniformemente. Padr√µes (cone, curva) indicam heterocedasticidade.

**Observa√ß√µes Influentes:**
Pontos fora das linhas tracejadas (Dist√¢ncia de Cook) s√£o observa√ß√µes influentes que merecem investiga√ß√£o.

##### Colinearidade e Normalidade

```{r}
#| echo: true
#| message: false
#| warning: false

check_model(modelo1_resp, 
            check = c("vif", "normality"))
```

**VIF (Variance Inflation Factor):**
- VIF < 5: Sem problemas
- VIF 5-10: Colinearidade moderada
- VIF > 10: Colinearidade severa

**Normalidade dos Res√≠duos:**
Pontos devem seguir a linha diagonal. Desvios nas caudas indicam problemas de predi√ß√£o nesses extremos.

:::

::: {.callout-warning}
## ‚ö†Ô∏è Avalia√ß√£o dos Pressupostos

Este modelo apresenta viola√ß√µes em diversos pressupostos. Veja a [se√ß√£o de solu√ß√µes](#sec-violacoes) ao final deste cap√≠tulo para estrat√©gias de corre√ß√£o.
:::

---

#### Visualiza√ß√£o Completa

::: {.callout-tip}
## üí° Painel Completo de Diagn√≥sticos

Use `check_model()` sem especificar `check` para ver todos os diagn√≥sticos em um √∫nico painel:
:::

```{r}
#| echo: true
#| fig-height: 10
#| fig-width: 12

check_model(modelo1_resp)
```

---

#### Visualiza√ß√£o do Modelo

```{r}
#| echo: true
#| message: false
#| warning: false

visualize(modelo1_resp, plot = "model")
```

---

#### Relat√≥rio Automatizado

::: {.callout-tip}
## ‚ö° Poder do `report()`

A fun√ß√£o `report()` do pacote `easystats` gera texto formatado para publica√ß√£o em ingl√™s, reduzindo erros de digita√ß√£o e aumentando reprodutibilidade.

**Importante:** Use com sabedoria! Sempre revise e compreenda os resultados antes de usar em publica√ß√µes.
:::

```{r}
#| echo: true

report(modelo1_resp)
```

---

### Modelo para "Pulse"

Agora ajustaremos o mesmo modelo para a vari√°vel de pulso:

$$
\text{pulse} = \beta_0 + \beta_1\text{drug} + \beta_2\text{Tempo} + \beta_3\text{drug} \times \text{Tempo} + \varepsilon
$$

```{r}
#| echo: true

modelo1_pulse <- lm(pulse ~ drug + Tempo + drug*Tempo, 
                    data = bd_long)

summary(modelo1_pulse)
```

---

#### Diagn√≥stico do Modelo

::: {.panel-tabset}

##### Predi√ß√£o e Linearidade

```{r}
#| echo: true
#| message: false
#| warning: false

check_model(modelo1_pulse, 
            check = c("pp_check", "linearity"))
```

##### Homogeneidade e Outliers

```{r}
#| echo: true
#| message: false
#| warning: false

check_model(modelo1_pulse, 
            check = c("homogeneity", "outliers"))
```

##### Colinearidade e Normalidade

```{r}
#| echo: true
#| message: false
#| warning: false

check_model(modelo1_pulse, 
            check = c("vif", "normality"))
```

:::

---

#### Visualiza√ß√£o do Modelo

```{r}
#| echo: true
#| message: false
#| warning: false

visualize(modelo1_pulse, plot = "model")
```

#### Relat√≥rio Automatizado

```{r}
#| echo: true

report(modelo1_pulse)
```

---

## üìä Parte 2: GEE (Equa√ß√µes de Estima√ß√£o Generalizadas)

### Modelo GEE para "Resp"

GEE oferece estimativas robustas mesmo quando a estrutura de correla√ß√£o n√£o √© perfeitamente especificada.

```{r}
#| echo: true
#| message: false
#| warning: false

modelo_gee_resp <- geeglm(
  resp ~ drug + Tempo + drug*Tempo,
  data = bd_long,
  id = ID,
  family = gaussian,
  corstr = "unstructured"
)

summary(modelo_gee_resp)
```

::: {.callout-note collapse="true"}
## üîç Par√¢metros do GEE

- **`id`:** Identificador do sujeito (observa√ß√µes repetidas)
- **`family`:** Distribui√ß√£o da vari√°vel resposta (gaussian, binomial, poisson)
- **`corstr`:** Estrutura de correla√ß√£o
  - `"independence"`: Sem correla√ß√£o
  - `"exchangeable"`: Correla√ß√£o constante
  - `"ar1"`: Autorregressiva de ordem 1
  - `"unstructured"`: Sem restri√ß√µes (mais flex√≠vel)
:::

---

#### Diagn√≥stico do Modelo GEE

```{r}
#| echo: true
#| message: false
#| warning: false

check_model(modelo_gee_resp)
```

#### Visualiza√ß√£o do Modelo

```{r}
#| echo: true
#| message: false
#| warning: false

visualize(modelo_gee_resp, plot = "model")
```

::: {.callout-warning}
## ‚ö†Ô∏è Limita√ß√£o do `report()`

A fun√ß√£o `report()` **n√£o funciona** para modelos GEE. Pratique escrever seus resultados manualmente!
:::

---

### Modelo GEE para "Pulse"

```{r}
#| echo: true
#| message: false
#| warning: false

modelo_gee_pulse <- geeglm(
  pulse ~ drug + Tempo + drug*Tempo,
  data = bd_long,
  id = ID,
  family = gaussian,
  corstr = "unstructured"
)

summary(modelo_gee_pulse)
```

---

#### Diagn√≥stico do Modelo

```{r}
#| echo: true
#| message: false
#| warning: false

check_model(modelo_gee_pulse)
```

#### Visualiza√ß√£o do Modelo

```{r}
#| echo: true
#| message: false
#| warning: false

visualize(modelo_gee_pulse, plot = "model")
```

---

## üìä Parte 3: GMM (Modelos Mistos Generalizados)

### Modelo GMM para "Resp"

Modelos mistos incorporam efeitos fixos e aleat√≥rios, capturando variabilidade entre e dentro de sujeitos.

```{r}
#| echo: true
#| message: false
#| warning: false

modelo_gmm_resp <- lme(
  fixed = resp ~ drug + Tempo + drug*Tempo,
  random = ~1|ID,
  data = bd_long
)

summary(modelo_gmm_resp)
```

::: {.callout-note collapse="true"}
## üîç Estrutura do Modelo Misto

- **`fixed`:** Efeitos fixos (mesmos do GLM)
- **`random = ~1|ID`:** Intercepto aleat√≥rio por sujeito
  - Captura variabilidade baseline entre indiv√≠duos
  - `~1` indica apenas intercepto aleat√≥rio
  - `|ID` agrupa por sujeito

**Estruturas mais complexas:**
- `~Tempo|ID`: Intercepto e slope aleat√≥rios
- `~1|Escola/Sala`: Hierarquia aninhada
:::

---

#### Diagn√≥stico do Modelo

```{r}
#| echo: true
#| message: false
#| warning: false

check_model(modelo_gmm_resp)
```

---

#### Visualiza√ß√£o do Modelo

::: {.callout-tip}
## üí° Visualiza√ß√£o Manual com ggplot2

A fun√ß√£o `visualize()` nem sempre funciona com modelos complexos. Vamos criar gr√°ficos manualmente com `ggplot2`:
:::

```{r}
#| echo: true
#| message: false
#| warning: false

# Calcular m√©dias marginais estimadas
means_ci_gmm_resp <- emmeans(modelo_gmm_resp, 
                              specs = ~drug:Tempo)

# Criar gr√°fico
ggplot(as.data.frame(means_ci_gmm_resp), 
       aes(x = Tempo, y = emmean, color = drug, group = drug)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL),
                width = 0.2,
                position = position_dodge(0.1)) +
  geom_point(position = position_dodge(0.1), 
             size = 3) +
  geom_line(position = position_dodge(0.1)) +
  labs(
    title = "Efeito da Droga na Respira√ß√£o ao Longo do Tempo",
    subtitle = "M√©dias marginais estimadas com IC 95%",
    x = "Tempo",
    y = "Respira√ß√£o (Resp)",
    color = "Tratamento"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold")
  )
```

#### Relat√≥rio Automatizado

```{r}
#| echo: true

report(modelo_gmm_resp)
```

---

### Modelo GMM para "Pulse"

```{r}
#| echo: true
#| message: false
#| warning: false

modelo_gmm_pulse <- lme(
  fixed = pulse ~ drug + Tempo + drug*Tempo,
  random = ~1|ID,
  data = bd_long
)

summary(modelo_gmm_pulse)
```

---

#### Diagn√≥stico do Modelo

```{r}
#| echo: true
#| message: false
#| warning: false

check_model(modelo_gmm_pulse)
```

---

#### Visualiza√ß√£o do Modelo

```{r}
#| echo: true
#| message: false
#| warning: false

# Calcular m√©dias marginais
means_ci_gmm_pulse <- emmeans(modelo_gmm_pulse, 
                               specs = ~drug:Tempo)

# Criar gr√°fico
ggplot(as.data.frame(means_ci_gmm_pulse),
       aes(x = Tempo, y = emmean, color = drug, group = drug)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL),
                width = 0.2,
                position = position_dodge(0.1)) +
  geom_point(position = position_dodge(0.1),
             size = 3) +
  geom_line(position = position_dodge(0.1)) +
  labs(
    title = "Efeito da Droga no Pulso ao Longo do Tempo",
    subtitle = "M√©dias marginais estimadas com IC 95%",
    x = "Tempo",
    y = "Pulso (Pulse)",
    color = "Tratamento"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold")
  )
```

#### Relat√≥rio Automatizado

```{r}
#| echo: true

report(modelo_gmm_pulse)
```

---

## üîß Viola√ß√£o dos Pressupostos: O Que Fazer? {#sec-violacoes}

::: {.callout-important}
## Guia de Solu√ß√µes para Viola√ß√µes

Quando seu modelo viola pressupostos, considere as seguintes estrat√©gias:
:::

::: {.panel-tabset}

### Multicolinearidade

**Problema:** Preditores altamente correlacionados entre si (VIF > 10)

**Solu√ß√µes:**

1. **Identificar correla√ß√µes**
   ```{r}
   #| eval: false
   cor(bd_long[, c("var1", "var2", "var3")])
   ```

2. **Remover vari√°vel redundante**
   - Manter a mais teoricamente relevante
   - Ou a com maior poder explicativo

3. **Criar √≠ndices compostos**
   - M√©dia ou soma ponderada de vari√°veis correlacionadas
   - An√°lise de componentes principais (PCA)

4. **Centralizar vari√°veis**
   ```{r}
   #| eval: false
   bd_long$var_centered <- scale(bd_long$var, scale = FALSE)
   ```

### Normalidade

**Problema:** Res√≠duos n√£o seguem distribui√ß√£o normal

**Solu√ß√µes:**

1. **Transforma√ß√µes de dados**
   ```{r}
   #| eval: false
   # Logar√≠tmica
   bd_long$resp_log <- log(bd_long$resp + 1)
   
   # Raiz quadrada
   bd_long$resp_sqrt <- sqrt(bd_long$resp)
   
   # Box-Cox
   library(MASS)
   bc <- boxcox(modelo1_resp)
   lambda <- bc$x[which.max(bc$y)]
   ```

2. **Modelos robustos**
   ```{r}
   #| eval: false
   library(robustbase)
   modelo_robusto <- lmrob(resp ~ drug + Tempo, data = bd_long)
   ```

3. **Modelos generalizados (GzLM)**
   - Use distribui√ß√µes mais apropriadas (Gamma, Poisson)

### Homogeneidade

**Problema:** Vari√¢ncia n√£o constante dos res√≠duos

**Solu√ß√µes:**

1. **Transforma√ß√£o da vari√°vel resposta**
   - Mesmas transforma√ß√µes da normalidade

2. **Pesos heteroced√°sticos**
   ```{r}
   #| eval: false
   library(nlme)
   modelo_hetero <- gls(
     resp ~ drug + Tempo,
     weights = varIdent(form = ~1|drug),
     data = bd_long
   )
   ```

3. **Erros-padr√£o robustos**
   ```{r}
   #| eval: false
   library(sandwich)
   library(lmtest)
   coeftest(modelo1_resp, vcov = vcovHC(modelo1_resp, type = "HC3"))
   ```

### Outliers

**Problema:** Observa√ß√µes extremamente influentes

**Solu√ß√µes:**

1. **Investigar outliers**
   ```{r}
   #| eval: false
   # Identificar outliers
   outliers <- which(cooks.distance(modelo1_resp) > 4/nrow(bd_long))
   bd_long[outliers, ]
   ```

2. **An√°lise de sensibilidade**
   - Refazer an√°lise com e sem outliers
   - Reportar ambos os resultados

3. **Modelos robustos**
   - Menos sens√≠veis a outliers

4. **Transforma√ß√µes**
   - Reduzir impacto de valores extremos

### Linearidade

**Problema:** Rela√ß√£o n√£o-linear entre preditores e resposta

**Solu√ß√µes:**

1. **Termos polinomiais**
   ```{r}
   #| eval: false
   modelo_quad <- lm(resp ~ drug + Tempo + I(Tempo^2), 
                     data = bd_long)
   ```

2. **Splines**
   ```{r}
   #| eval: false
   library(splines)
   modelo_spline <- lm(resp ~ drug + bs(Tempo, df = 3), 
                       data = bd_long)
   ```

3. **Modelos aditivos generalizados (GAM)**
   ```{r}
   #| eval: false
   library(mgcv)
   modelo_gam <- gam(resp ~ drug + s(Tempo), 
                     data = bd_long)
   ```

### Ajuste Global

**Problema:** Modelo n√£o se ajusta bem aos dados (Posterior Predictive)

**Solu√ß√µes:**

1. **Revisar especifica√ß√£o do modelo**
   - Adicionar intera√ß√µes relevantes
   - Incluir preditores omitidos

2. **Mudar distribui√ß√£o**
   - De gaussian para Gamma, Poisson, etc.

3. **Considerar n√£o-linearidades**
   - GAM, splines, polin√¥mios

4. **Modelos mais flex√≠veis**
   - Random forests, boosting (explorat√≥rio)

:::

::: {.callout-tip}
## üí° Estrat√©gia Geral

1. **Identifique** todas as viola√ß√µes
2. **Priorize** as mais severas
3. **Aplique** solu√ß√µes sequencialmente
4. **Reavalie** ap√≥s cada mudan√ßa
5. **Documente** todas as tentativas
6. Se tudo falhar, **reconhe√ßa limita√ß√µes** do modelo
:::

---

## üìù Conclus√£o

::: {.callout-note appearance="simple"}
## Resumo da Lista

Neste tutorial, exploramos tr√™s abordagens complementares para an√°lise de medidas repetidas:

**GLM:** Abordagem cl√°ssica, pressup√µe esfericidade  
**GEE:** Robusto √† especifica√ß√£o de correla√ß√£o, foco em efeitos populacionais  
**GMM:** Modela variabilidade individual, permite estruturas hier√°rquicas

Cada m√©todo tem vantagens espec√≠ficas. A escolha depende de:
- Estrutura dos dados
- Pergunta de pesquisa
- Pressupostos atendidos
- Interpreta√ß√£o desejada

**Pr√≥ximos passos:** Listas subsequentes comparar√£o estes m√©todos em diferentes cen√°rios.
:::

---

## üìö Recursos Complementares

### Aula em V√≠deo (SPSS)

{{< video https://www.youtube.com/watch?v=_KtjZcaMYhk&list=PLZjaOxYREinslupYDLvknGMB-U-Kl8G7k&index=1 title='GLM Repeated Measures, GEE, GMM - Aula Pr√°tica #1 (SPSS)' >}}

---

### Refer√™ncias Recomendadas

::: {.callout-note collapse="true"}
## üìñ Leituras Complementares

**Testes e pressupostos:**
- [Mauchly's Test of Sphericity in R](https://www.datanovia.com/en/lessons/mauchlys-test-of-sphericity-in-r/)

**Manipula√ß√£o de dados:**
- [Pivoting multiple variables - YouTube](https://www.youtube.com/watch?v=dcWuHcC98EU&t=196s)
- [Wide to long format part 2 - YouTube](https://www.youtube.com/watch?v=4-sqsCANxHU)

**Modelos avan√ßados:**
- Pinheiro & Bates (2000). *Mixed-Effects Models in S and S-PLUS*
- Fitzmaurice et al. (2011). *Applied Longitudinal Analysis*
- West et al. (2014). *Linear Mixed Models: A Practical Guide*
:::

---

## üîß Informa√ß√µes de Sess√£o

```{r}
#| echo: true

report(sessionInfo())
```

::: {.callout-tip}
## üí° Reprodutibilidade

Sempre inclua `sessionInfo()` ao final de suas an√°lises para documentar vers√µes de pacotes e garantir reprodutibilidade!
:::