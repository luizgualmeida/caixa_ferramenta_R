# Lista 2: GEE Avan√ßado {.unnumbered}

::: {.callout-note appearance="simple" icon=false}
## Objetivo da Lista

Nesta lista, voc√™ explorar√° a flexibilidade dos modelos GEE testando **diferentes distribui√ß√µes de probabilidade** (Normal, Gamma e Tweedie). Aprender√° a comparar modelos usando o **QIC** e a escolher a distribui√ß√£o mais adequada para seus dados.
:::

---

## üì¶ Pacotes Necess√°rios

```{r}
#| echo: true
#| message: false
#| warning: false

# Lista completa de pacotes
pacotes <- c(
  "emmeans", "lme4", "nlme", "flexplot", "foreign",
  "tidyr", "dplyr", "multcomp", "effects", "sjstats",
  "car", "rstatix", "geepack", "performance", "see",
  "rempsyc", "easystats", "GGally", "gee", "tweedie",
  "stats", "statmod", "fitdistrplus", "ggplot2"
)

# Verificar e instalar faltantes
pacotes_faltantes <- pacotes[!pacotes %in% installed.packages()[, "Package"]]
if (length(pacotes_faltantes) > 0) {
  cat("Instalando:", paste(pacotes_faltantes, collapse = ", "), "\n")
  install.packages(pacotes_faltantes, dependencies = TRUE)
}

# Carregar silenciosamente
invisible(lapply(pacotes, library, character.only = TRUE))
cat("‚úì Pacotes carregados!\n")
```

---

## üì• Prepara√ß√£o dos Dados

::: {.callout-important}
## Download Necess√°rio

Use o mesmo banco **"[New Drug](https://drive.google.com/file/d/145uyQOn_3Mk_CQxpu-pFKfm8u7DE257U/view?usp=sharing)"** da Lista 1. 
:::

### Carregamento e Transforma√ß√£o

```{r}
#| echo: true
#| warning: false
#| message: false

# 1. Carregar dados originais
original_wide <- read.spss("bd_New drug_respiratory&pulse.sav", 
                           to.data.frame = TRUE)

# 2. Renomear colunas
bd <- original_wide %>%
  rename_with(~gsub("(resp|pulse)(\\d+)", "\\1_\\2", .), -drug) %>%
  mutate(ID = row_number()) %>%
  select(ID, everything())

# 3. Converter para formato long
bd_long <- pivot_longer(
  bd,
  cols = resp_1:pulse_3,
  names_to = c(".value", "Tempo"),
  names_pattern = "(.+)_(.+)"
)

# 4. Converter para fatores
bd_long$ID <- factor(bd_long$ID)
bd_long$Tempo <- factor(bd_long$Tempo)

# Visualizar estrutura
head(bd_long)
```

---

## üéØ Parte A: Modelos GEE com Diferentes Distribui√ß√µes

::: {.callout-tip}
## Por que Testar Diferentes Distribui√ß√µes?

A escolha da distribui√ß√£o afeta:
- **Ajuste do modelo** aos dados
- **Interpreta√ß√£o dos coeficientes**
- **Precis√£o das predi√ß√µes**
- **Validade das infer√™ncias**

Testar m√∫ltiplas distribui√ß√µes ajuda a identificar qual melhor representa seus dados.
:::

---

### Modelo 1: Distribui√ß√£o Normal (Gaussian)

#### Ajuste do Modelo

```{r}
#| echo: true
#| message: false
#| warning: false

modelo_gee_pulse_normal <- geeglm(
  pulse ~ drug + Tempo + drug*Tempo,
  data = bd_long,
  id = ID,
  family = gaussian,
  corstr = "unstructured"
)
```

::: {.callout-note collapse="true"}
## üìä Quando Usar Distribui√ß√£o Normal?

**Adequada para:**
- Vari√°veis cont√≠nuas
- Distribui√ß√£o sim√©trica
- Sem limite inferior ou superior r√≠gido

**Caracter√≠sticas:**
- Link: identidade (padr√£o)
- Vari√¢ncia: constante
- Suporte: $(-\infty, +\infty)$
:::

---

#### Resultados e Contrastes

```{r}
#| echo: true

summary(modelo_gee_pulse_normal)
```

::: {.panel-tabset}

##### M√©dias Marginais

```{r}
#| echo: true

emmeans(modelo_gee_pulse_normal, 
        specs = ~drug*Tempo)
```

##### Compara√ß√µes Par-a-Par

```{r}
#| echo: true

emmeans(modelo_gee_pulse_normal, 
        pairwise ~ drug*Tempo)
```

:::

---

#### Diagn√≥stico do Modelo

```{r}
#| echo: true
#| message: false
#| warning: false
#| fig-height: 10
#| fig-width: 12

check_model(modelo_gee_pulse_normal)
```

---

#### Visualiza√ß√£o dos Resultados

```{r}
#| echo: true
#| message: false
#| warning: false

# Calcular m√©dias marginais
means_ci_normal <- emmeans(modelo_gee_pulse_normal, 
                           specs = ~drug:Tempo)

# Criar gr√°fico elegante
ggplot(as.data.frame(means_ci_normal), 
       aes(x = Tempo, y = emmean, color = drug, group = drug)) +
  geom_errorbar(
    aes(ymin = lower.CL, ymax = upper.CL),
    width = 0.2,
    position = position_dodge(0.1)
  ) +
  geom_point(
    position = position_dodge(0.1),
    size = 4
  ) +
  geom_line(
    position = position_dodge(0.1),
    linewidth = 1
  ) +
  labs(
    title = "GEE com Distribui√ß√£o Normal",
    subtitle = "M√©dias marginais estimadas com IC 95%",
    x = "Tempo",
    y = "Pulso (bpm)",
    color = "Tratamento"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold", size = 15),
    panel.grid.minor = element_blank()
  ) +
  scale_color_brewer(palette = "Set1")
```

---

### Modelo 2: Distribui√ß√£o Gamma

#### Ajuste do Modelo

```{r}
#| echo: true
#| message: false
#| warning: false

modelo_gee_pulse_gamma <- geeglm(
  pulse ~ drug + Tempo + drug*Tempo,
  data = bd_long,
  id = ID,
  family = Gamma(link = "identity"),
  corstr = "unstructured"
)
```

::: {.callout-note collapse="true"}
## üìä Quando Usar Distribui√ß√£o Gamma?

**Adequada para:**
- Vari√°veis cont√≠nuas **positivas**
- Distribui√ß√£o assim√©trica √† direita
- Vari√¢ncia proporcional √† m√©dia

**Caracter√≠sticas:**
- Link comum: log ou identity
- Vari√¢ncia: aumenta com a m√©dia
- Suporte: $(0, +\infty)$

**Exemplos:**
- Tempo de rea√ß√£o
- Tempo de sobrevida
- Concentra√ß√µes biomarcadores
:::

---

#### Resultados e Contrastes

```{r}
#| echo: true

summary(modelo_gee_pulse_gamma)
```

::: {.panel-tabset}

##### M√©dias Marginais

```{r}
#| echo: true

emmeans(modelo_gee_pulse_gamma, 
        specs = ~drug*Tempo)
```

##### Compara√ß√µes Par-a-Par

```{r}
#| echo: true

emmeans(modelo_gee_pulse_gamma, 
        pairwise ~ drug*Tempo)
```

:::

---

#### Diagn√≥stico do Modelo

```{r}
#| echo: true
#| message: false
#| warning: false
#| fig-height: 10
#| fig-width: 12

check_model(modelo_gee_pulse_gamma)
```

---

#### Visualiza√ß√£o dos Resultados

```{r}
#| echo: true
#| message: false
#| warning: false

# Calcular m√©dias marginais
means_ci_gamma <- emmeans(modelo_gee_pulse_gamma, 
                          specs = ~drug:Tempo)

# Criar gr√°fico
ggplot(as.data.frame(means_ci_gamma),
       aes(x = Tempo, y = emmean, color = drug, group = drug)) +
  geom_errorbar(
    aes(ymin = lower.CL, ymax = upper.CL),
    width = 0.2,
    position = position_dodge(0.1)
  ) +
  geom_point(
    position = position_dodge(0.1),
    size = 4
  ) +
  geom_line(
    position = position_dodge(0.1),
    linewidth = 1
  ) +
  labs(
    title = "GEE com Distribui√ß√£o Gamma",
    subtitle = "M√©dias marginais estimadas com IC 95%",
    x = "Tempo",
    y = "Pulso (bpm)",
    color = "Tratamento"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold", size = 15),
    panel.grid.minor = element_blank()
  ) +
  scale_color_brewer(palette = "Set1")
```

---

### Modelo 3: Distribui√ß√£o Tweedie

::: {.callout-warning}
## ‚ö†Ô∏è Implementa√ß√£o Limitada

Atualmente, a fun√ß√£o `geeglm()` n√£o suporta nativamente a fam√≠lia Tweedie. Estamos usando `glm()` como alternativa, mas isso **n√£o** captura a estrutura de correla√ß√£o das medidas repetidas.

**Recomenda√ß√µes:**
- Para an√°lises definitivas, use SPSS ou SAS que implementam GEE-Tweedie
- Considere `glmmTMB::glmmTMB()` como alternativa (modelo misto)
- Aguarde atualiza√ß√µes do pacote `geepack`
:::

#### Ajuste do Modelo (Limitado)

```{r}
#| echo: true
#| message: false
#| warning: false

modelo_gee_pulse_tweedie <- glm(
  pulse ~ drug + Tempo + drug*Tempo,
  data = bd_long,
  family = tweedie(var.power = 2, link.power = 0)
)
```

::: {.callout-note collapse="true"}
## üìä Quando Usar Distribui√ß√£o Tweedie?

**Adequada para:**
- Dados com **excesso de zeros**
- Distribui√ß√£o assim√©trica
- Vari√¢ncia aumenta com a m√©dia

**Caracter√≠sticas:**
- Par√¢metro `var.power`:
  - 0 = Normal
  - 1 = Poisson
  - 2 = Gamma
  - 1-2 = Distribui√ß√µes compostas
- Flex√≠vel para diferentes tipos de assimetria

**Exemplos:**
- Custos m√©dicos (muitos zeros)
- Precipita√ß√£o pluviom√©trica
- Dados de contagem inflados de zeros
:::

---

#### Resultados e Contrastes

```{r}
#| echo: true

summary(modelo_gee_pulse_tweedie)
```

::: {.panel-tabset}

##### M√©dias Marginais

```{r}
#| echo: true

emmeans(modelo_gee_pulse_tweedie, 
        specs = ~drug*Tempo)
```

##### Compara√ß√µes Par-a-Par

```{r}
#| echo: true

emmeans(modelo_gee_pulse_tweedie, 
        pairwise ~ drug*Tempo)
```

:::

---

#### Diagn√≥stico do Modelo

```{r}
#| echo: true
#| message: false
#| warning: false
#| fig-height: 10
#| fig-width: 12

check_model(modelo_gee_pulse_tweedie)
```

---

#### Visualiza√ß√£o dos Resultados

```{r}
#| echo: true
#| message: false
#| warning: false

# Calcular m√©dias marginais
means_ci_tweedie <- emmeans(modelo_gee_pulse_tweedie, 
                            specs = ~drug:Tempo)

# Criar gr√°fico
ggplot(as.data.frame(means_ci_tweedie),
       aes(x = Tempo, y = emmean, color = drug, group = drug)) +
  geom_errorbar(
    aes(ymin = asymp.LCL, ymax = asymp.UCL),
    width = 0.2,
    position = position_dodge(0.1)
  ) +
  geom_point(
    position = position_dodge(0.1),
    size = 4
  ) +
  geom_line(
    position = position_dodge(0.1),
    linewidth = 1
  ) +
  labs(
    title = "GLM com Distribui√ß√£o Tweedie",
    subtitle = "M√©dias marginais estimadas com IC 95% (sem estrutura de correla√ß√£o)",
    x = "Tempo",
    y = "Pulso (bpm)",
    color = "Tratamento",
    caption = "Nota: Modelo n√£o captura correla√ß√£o entre medidas repetidas"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold", size = 15),
    panel.grid.minor = element_blank(),
    plot.caption = element_text(face = "italic", hjust = 0)
  ) +
  scale_color_brewer(palette = "Set1")
```

---

## üéØ Parte B: Compara√ß√£o de Modelos com QIC

::: {.callout-tip}
## O que √© QIC?

**Quasi-likelihood Information Criterion** √© an√°logo ao AIC, mas para modelos GEE.

**Interpreta√ß√£o:**
- Menor QIC = melhor modelo
- Diferen√ßa > 2 indica melhoria substancial
- Penaliza complexidade do modelo

**Componentes:**
- QIC: Informa√ß√£o geral
- QICu: Vers√£o n√£o ajustada
- Quasi Lik: Quasi-verossimilhan√ßa
:::

### C√°lculo do QIC

```{r}
#| echo: true
#| warning: false

# Calcular QIC para modelos GEE
qic_normal <- QIC(modelo_gee_pulse_normal)
qic_gamma <- QIC(modelo_gee_pulse_gamma)

# Criar tabela comparativa
tabela_qic <- data.frame(
  Modelo = c("Normal", "Gamma"),
  QIC = c(qic_normal[1], qic_gamma[1]),
  QICu = c(qic_normal[2], qic_gamma[2]),
  QuasiLik = c(qic_normal[3], qic_gamma[3])
)

# Ordenar por QIC
tabela_qic <- tabela_qic[order(tabela_qic$QIC), ]

# Adicionar ranking
tabela_qic$Ranking <- 1:nrow(tabela_qic)

# Exibir resultado
knitr::kable(
  tabela_qic,
  digits = 2,
  caption = "Compara√ß√£o de Modelos via QIC (menor √© melhor)"
)
```

::: {.callout-warning}
## ‚ö†Ô∏è Limita√ß√£o do QIC

A fun√ß√£o `QIC()` **n√£o funciona** com modelos `glm()` ou `lm()`, apenas com `geeglm()`.

Para o modelo Tweedie, voc√™ precisar√°:
- Usar software espec√≠fico (SPSS, SAS)
- Aguardar implementa√ß√£o em R
- Comparar apenas Normal vs Gamma por enquanto
:::

---

### Interpreta√ß√£o dos Resultados

::: {.panel-tabset}

#### Diferen√ßas Substantivas

**Regra pr√°tica:**
- ŒîqIC < 2: Modelos equivalentes
- ŒîqIC 2-10: Diferen√ßa moderada
- ŒîqIC > 10: Diferen√ßa substancial

```{r}
#| echo: true

# Calcular diferen√ßas
delta_qic <- abs(diff(tabela_qic$QIC))

cat("Diferen√ßa QIC:", round(delta_qic, 2), "\n")

if (delta_qic < 2) {
  cat("‚Üí Modelos s√£o equivalentes\n")
} else if (delta_qic < 10) {
  cat("‚Üí Diferen√ßa moderada - considere outros fatores\n")
} else {
  cat("‚Üí Diferen√ßa substancial - prefira modelo com menor QIC\n")
}
```

#### Outros Crit√©rios

Al√©m do QIC, considere:

1. **Pressupostos te√≥ricos**
   - Qual distribui√ß√£o faz sentido para a vari√°vel?
   - Pulse tem limite inferior (> 0)?

2. **Diagn√≥sticos visuais**
   - Qual modelo tem melhores diagn√≥sticos?
   - Res√≠duos mais bem comportados?

3. **Interpretabilidade**
   - Coeficientes fazem sentido?
   - Intervalos de confian√ßa plaus√≠veis?

4. **Valida√ß√£o cruzada**
   - Como o modelo prediz novos dados?

:::

---

## üìù Parte C: Sumarizando Resultados

::: {.callout-warning}
## Limita√ß√£o do `report()`

A fun√ß√£o `report()` **n√£o funciona** para modelos GEE (`geeglm`). 

**Funciona apenas para:** `glm`, `lm`, `lme`, etc.

Aproveite para **treinar escrita cient√≠fica**! 
:::

### Exemplo de Relat√≥rio - Modelo Tweedie

```{r}
#| echo: true

report(modelo_gee_pulse_tweedie)
```

---

### Template para Reda√ß√£o Manual

::: {.callout-tip collapse="true"}
## üìù Estrutura Sugerida para Resultados

**Para GEE, estruture seus resultados assim:**

---

**An√°lise de Medidas Repetidas via GEE**

Utilizamos Equa√ß√µes de Estima√ß√£o Generalizadas (GEE) com estrutura de correla√ß√£o n√£o-estruturada para modelar a trajet√≥ria de pulso ao longo de tr√™s momentos de avalia√ß√£o (Tempo 1, 2, 3), comparando grupo experimental (droga) e controle (placebo).

**Compara√ß√£o de Distribui√ß√µes**

Testamos tr√™s especifica√ß√µes de distribui√ß√£o:
- Gaussiana (Normal)
- Gamma
- Tweedie (var.power = 2)

A compara√ß√£o via QIC indicou que [MODELO X] apresentou melhor ajuste (QIC = X.XX), seguido por [MODELO Y] (QIC = Y.YY, ŒîQIC = Z.ZZ).

**Resultados Principais**

No modelo [ESCOLHIDO]:

*Efeito de Grupo:*
- O grupo que recebeu droga apresentou [maior/menor] pulso comparado ao placebo (Œ≤ = X.XX, EP = Y.YY, p = Z.ZZ)

*Efeito de Tempo:*
- Observou-se [aumento/redu√ß√£o/estabilidade] no pulso ao longo do tempo (Œ≤_Tempo2 = X.XX, p = Y.YY; Œ≤_Tempo3 = A.AA, p = B.BB)

*Intera√ß√£o Grupo √ó Tempo:*
- [Houve/N√£o houve] intera√ß√£o significativa, indicando que [INTERPRETA√á√ÉO]

**M√©dias Estimadas**

As m√©dias marginais estimadas revelaram que:
- No Tempo 1: Droga M = X.X (IC95% Y.Y-Z.Z), Placebo M = A.A (IC95% B.B-C.C)
- No Tempo 2: [continuar...]
- No Tempo 3: [continuar...]

**Conclus√£o**

[Resumo dos achados principais e implica√ß√µes]

---
:::

---

## üéØ Desafio: An√°lise da Vari√°vel "Resp"

::: {.callout-important}
## Sua Vez!

Agora replique **todas as an√°lises** para a vari√°vel **"resp"** (respira√ß√£o):

**Checklist:**
- [ ] Modelo GEE com distribui√ß√£o Normal
- [ ] Modelo GEE com distribui√ß√£o Gamma
- [ ] Modelo GLM com distribui√ß√£o Tweedie
- [ ] Diagn√≥sticos de cada modelo
- [ ] Visualiza√ß√µes com ggplot2
- [ ] Compara√ß√£o via QIC
- [ ] Interpreta√ß√£o dos resultados
- [ ] Reda√ß√£o cient√≠fica dos achados
:::

::: {.callout-tip}
## üí° Dica Importante

**N√£o fa√ßa apenas copy/paste!**

1. **Digite os c√≥digos** para treinar sintaxe
2. **Renomeie vari√°veis** apropriadamente:
   - `modelo_gee_pulse_normal` ‚Üí `modelo_gee_resp_normal`
   - `means_ci_normal` ‚Üí `means_ci_resp_normal`
3. **Ajuste labels** nos gr√°ficos (Pulse ‚Üí Resp)
4. **Compare** seus resultados com a aula pr√°tica
5. **Reflita** sobre diferen√ßas entre as vari√°veis
:::

---

## üìö Material Complementar

### Aula em V√≠deo (SPSS)

{{< video https://www.youtube.com/watch?v=qd0qF2lRqIs title='GEE - Generalized Estimated Equations - Aula Pr√°tica #2 (SPSS)' >}}

---

### Aprofundamento Te√≥rico

::: {.callout-note collapse="true"}
## üìñ Entendendo Distribui√ß√µes

**Normal (Gaussian):**
- Cl√°ssica, sim√©trica, bem conhecida
- Assume vari√¢ncia constante
- Adequada para muitas vari√°veis cont√≠nuas

**Gamma:**
- Assim√©trica √† direita
- Vari√¢ncia aumenta com a m√©dia
- Ideal para tempos, concentra√ß√µes

**Tweedie:**
- Fam√≠lia flex√≠vel entre Poisson e Gamma
- `var.power` controla forma:
  - 0: Normal
  - 1: Poisson  
  - 2: Gamma
  - 1 < p < 2: Distribui√ß√µes compostas
- √ötil para dados com zeros

**Como escolher?**
1. Examine distribui√ß√£o dos dados (histogramas)
2. Considere natureza da vari√°vel (positiva? cont√≠nua?)
3. Teste m√∫ltiplas e compare QIC
4. Verifique pressupostos (diagn√≥sticos)
:::

---

### Estruturas de Correla√ß√£o GEE

::: {.callout-note collapse="true"}
## üîó Tipos de `corstr`

**Independence:**
- Assume observa√ß√µes independentes
- Mais simples, menos realista

**Exchangeable:**
- Correla√ß√£o constante entre momentos
- Assume simetria composta

**AR(1) - Autorregressiva:**
- Correla√ß√£o diminui com dist√¢ncia temporal
- Adequada para s√©ries temporais

**Unstructured:**
- Sem restri√ß√µes, mais flex√≠vel
- Estima todas as correla√ß√µes
- Requer mais dados

**Como escolher?**
- Depende da estrutura temporal
- `unstructured` √© mais flex√≠vel mas menos eficiente
- AR(1) para medi√ß√µes igualmente espa√ßadas
- Teste e compare resultados
:::

---

## üîß Informa√ß√µes de Sess√£o

```{r}
#| echo: true

report(sessionInfo())
```

---

::: {.callout-note appearance="simple"}
## üéì Resumo da Lista 2

Nesta lista voc√™:

‚úÖ Ajustou modelos GEE com **tr√™s distribui√ß√µes diferentes**  
‚úÖ Aprendeu a **comparar modelos** via QIC  
‚úÖ Criou **visualiza√ß√µes profissionais** com ggplot2  
‚úÖ Interpretou **diagn√≥sticos** de modelos complexos  
‚úÖ Praticou **reda√ß√£o cient√≠fica** de resultados  

**Pr√≥ximos passos:**
- Complete an√°lises para vari√°vel "resp"
- Compare resultados entre pulse e resp
- Reflita sobre qual distribui√ß√£o √© mais adequada
- Prepare-se para Lista 3: Modelos Mistos!
:::